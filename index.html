<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Stitch | Inventory</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-gradient {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
        }

        .table-row-hover:hover {
            background: rgba(241, 245, 249, 0.5);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <div id="auth-screen" class="flex flex-col items-center justify-center h-screen bg-[#0f172a] text-white">
        <div class="p-10 text-center scale-up-center">
            <img src="logo.png" alt="Real Stitch" class="w-32 h-32 mx-auto mb-6 object-contain" onerror="this.style.display='none'">
            
            <h1 class="text-6xl font-extrabold tracking-tighter mb-2 italic">REAL <span class="text-indigo-500">STITCH</span></h1>
            <p class="text-slate-400 mb-10 tracking-widest uppercase text-sm">Tailored Inventory Excellence</p>
            <button id="login-btn" class="bg-white text-slate-900 px-10 py-4 rounded-full font-bold shadow-2xl flex items-center gap-3 mx-auto hover:bg-indigo-50 transition-all">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5"> 
                Continue with Google
            </button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <nav class="sticky top-0 z-50 glass-card border-b border-slate-200 px-6 py-4 mb-8">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="RS" class="w-10 h-10 object-contain rounded-md" onerror="this.style.display='none'; document.getElementById('nav-fallback').classList.remove('hidden')">
                    
                    <div id="nav-fallback" class="hidden w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold italic text-xs">RS</div>
                    
                    <span class="text-xl font-extrabold tracking-tight">REAL STITCH</span>
                </div>
                <button id="logout-btn" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-rose-50 hover:text-rose-600 transition-colors">Logout</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 pb-20">
            <!-- QUICK TIP BANNER -->
            <div id="quick-tip" class="glass-card p-6 rounded-3xl shadow-xl mb-8 border-2 border-indigo-200">
                <div class="flex items-start gap-4">
                    <div class="bg-indigo-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl flex-shrink-0">
                        üí°
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-lg mb-2 text-indigo-900">Quick Start Guide</h4>
                        <p class="text-sm text-slate-600 mb-3">
                            <strong>Step 1:</strong> Create a batch (e.g., "Batch 003") using the <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-semibold">Batch Mgmt</span> tab ‚Üí
                            <strong>Step 2:</strong> Add items to your batch using <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-semibold">New Item</span> tab ‚Üí
                            <strong>Step 3:</strong> Track expenses and tailors for each batch ‚Üí
                            <strong>Step 4:</strong> View analytics to see your profit margins!
                        </p>
                        <div class="flex gap-2">
                            <button id="show-full-help" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-600">
                                View Full Guide
                            </button>
                            <button id="dismiss-tip" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-200">
                                Got it, dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1">
                    <div class="glass-card p-8 rounded-3xl shadow-xl sticky top-28">
                        <div class="flex gap-2 mb-6">
                            <button id="tab-batch" class="flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-indigo-500 text-white">Batch Mgmt</button>
                            <button id="tab-item" class="flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-slate-100 text-slate-600">New Item</button>
                        </div>

                        <!-- BATCH MANAGEMENT FORM -->
                        <div id="batch-form-container">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                                <span class="w-2 h-6 bg-indigo-500 rounded-full"></span> Batch Management
                            </h3>
                            <form id="batch-form" class="space-y-5">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Batch Name</label>
                                    <input type="text" id="batch-name" placeholder="e.g. Batch 003" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Total Shirts</label>
                                    <input type="number" id="batch-total" placeholder="50" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Long Sleeve</label>
                                        <input type="number" id="batch-long" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Short Sleeve</label>
                                        <input type="number" id="batch-short" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Plain</label>
                                        <input type="number" id="batch-plain" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Patterned</label>
                                        <input type="number" id="batch-patterned" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Custom Made</label>
                                    <input type="number" id="batch-custom" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                </div>
                                <button type="submit" class="w-full btn-gradient text-white p-4 rounded-2xl font-bold mt-4">Create Batch</button>
                            </form>
                        </div>

                        <!-- ITEM FORM -->
                        <div id="item-form-container" class="hidden">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                                <span class="w-2 h-6 bg-indigo-500 rounded-full"></span> New Entry
                            </h3>
                            <form id="inventory-form" class="space-y-5">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Select Batch</label>
                                    <select id="item-batch" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                        <option value="">Select Batch</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Item Name</label>
                                    <input type="text" id="item-name" placeholder="e.g. Silk Blazer" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Serial/Code</label>
                                    <input type="text" id="item-code" placeholder="RS-001" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Sleeve Type</label>
                                        <select id="item-sleeve" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                            <option value="Long Sleeve">Long Sleeve</option>
                                            <option value="Short Sleeve">Short Sleeve</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Material</label>
                                        <input type="text" id="item-material" placeholder="e.g. Plain, Patterned, Stripped" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Custom Made?</label>
                                    <select id="item-custom" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Selling Price</label>
                                    <input type="number" id="item-price" placeholder="‚Ç¶" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Size</label>
                                        <input type="text" id="item-size" placeholder="e.g. M, L, XL" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Colour</label>
                                        <input type="text" id="item-colour" placeholder="e.g. Red, Blue" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Product Photo (Optional)</label>
                                    <input type="file" id="item-image" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                </div>
                                
                                <!-- Bulk Excel Import -->
                                <div class="border-t border-slate-200 pt-4 mt-4">
                                    <div class="bg-blue-50 p-4 rounded-xl mb-3">
                                        <h4 class="font-bold text-sm text-blue-900 mb-2">üìä Bulk Import via Excel</h4>
                                        <p class="text-xs text-blue-700 mb-2">Upload an Excel file with columns: <strong>Item Name, Code, Sleeve Type (long/short), Material, Custom Made (Yes/No), Selling Price, Size, Colour</strong></p>
                                        <p class="text-xs text-blue-600">Note: Batch must be selected above. Photos not supported in bulk import.</p>
                                    </div>
                                    <input type="file" id="bulk-excel" accept=".xlsx,.xls" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <button type="button" id="process-excel-btn" class="w-full bg-blue-500 text-white p-3 rounded-xl font-bold mt-3">Import from Excel</button>
                                </div>
                                
                                <button type="submit" id="submit-btn" class="w-full btn-gradient text-white p-4 rounded-2xl font-bold mt-4">Save to Collection</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="flex gap-2 mb-6">
                        <button id="view-batches" class="flex-1 bg-indigo-100 text-indigo-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">View Batches</button>
                        <button id="view-expenses" class="flex-1 bg-purple-100 text-purple-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Expenses</button>
                        <button id="view-tailors" class="flex-1 bg-blue-100 text-blue-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Tailors</button>
                        <button id="view-analytics" class="flex-1 bg-amber-100 text-amber-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Analytics</button>
                        <button id="view-catalog" class="flex-1 bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Catalog</button>
                        <button id="view-users" class="hidden flex-1 bg-rose-100 text-rose-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">User Management</button>
                    </div>

                    <!-- CATALOG VIEW -->
                    <div id="catalog-view">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Master Catalog</h3>
                                <p class="text-slate-500 text-sm">Manage your stock levels and sales.</p>
                            </div>
                            <div class="flex gap-3 items-center">
                                <div class="bg-slate-50 px-4 py-2 rounded-xl">
                                    <input type="text" id="catalog-search" placeholder="Search by name or code..." class="bg-transparent outline-none text-sm w-64">
                                </div>
                                <div class="bg-indigo-50 px-4 py-2 rounded-xl">
                                    <label class="text-xs font-bold text-indigo-600 uppercase">Filter by Batch:</label>
                                    <select id="catalog-batch-filter" class="bg-transparent outline-none font-semibold text-sm ml-2">
                                        <option value="">All Batches</option>
                                    </select>
                                </div>
                                <button id="download-sold-pdf" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-emerald-100 transition-all flex items-center gap-2">
                                    PDF Export
                                </button>
                            </div>
                        </div>

                        <div id="catalog-by-batches"></div>
                    </div>

                    <!-- BATCHES VIEW -->
                    <div id="batches-view" class="hidden">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Production Batches</h3>
                                <p class="text-slate-500 text-sm">Track batch production and costs.</p>
                            </div>
                        </div>
                        <div id="batches-list" class="space-y-4"></div>
                    </div>

                    <!-- EXPENSES VIEW -->
                    <div id="expenses-view" class="hidden">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Batch Expenses</h3>
                                <p class="text-slate-500 text-sm">Track all production costs.</p>
                            </div>
                            <button id="add-expense-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">+ Add Expense</button>
                        </div>
                        <div id="expenses-list" class="glass-card rounded-3xl shadow-xl p-6"></div>
                    </div>

                    <!-- ADD EXPENSE MODAL -->
                    <div id="expense-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
                            <h3 class="text-2xl font-bold mb-6">Add New Expense</h3>
                            <form id="expense-form" class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Select Batch</label>
                                    <select id="expense-batch" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" required>
                                        <option value="">Choose a batch</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Category</label>
                                    <select id="expense-category" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" required>
                                        <option value="">Select category</option>
                                        <option value="Material">Material</option>
                                        <option value="Transport">Transport</option>
                                        <option value="Airtime">Airtime</option>
                                        <option value="Waybill">Waybill</option>
                                        <option value="Ironing">Ironing</option>
                                        <option value="Mending">Mending</option>
                                        <option value="Stock Keeper Fee">Stock Keeper Fee</option>
                                        <option value="Operations Specialist">Operations Specialist</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Additional Details (Optional)</label>
                                    <input type="text" id="expense-details" placeholder="e.g. Name of ironer, supplier, etc." class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                </div>
                                <div id="custom-expense-name-container" class="hidden">
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Custom Expense Name</label>
                                    <input type="text" id="custom-expense-name" placeholder="Enter expense name" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Amount (‚Ç¶)</label>
                                    <input type="number" id="expense-amount" step="0.01" placeholder="0.00" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="button" id="cancel-expense" class="flex-1 bg-slate-100 text-slate-600 p-3 rounded-xl font-bold">Cancel</button>
                                    <button type="submit" class="flex-1 btn-gradient text-white p-3 rounded-xl font-bold">Add Expense</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- TAILORS VIEW -->
                    <div id="tailors-view" class="hidden">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Tailor Management</h3>
                                <p class="text-slate-500 text-sm">Track tailoring assignments and payments.</p>
                            </div>
                            <button id="add-tailor-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">+ Add Task</button>
                        </div>
                        <div id="tailors-list" class="space-y-4"></div>
                    </div>

                    <!-- ADD TAILOR MODAL -->
                    <div id="tailor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <h3 class="text-2xl font-bold mb-6">Add Tailor Task</h3>
                            <form id="tailor-form" class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Select Batch</label>
                                    <select id="tailor-batch" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" required>
                                        <option value="">Choose a batch</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Tailor Name</label>
                                    <input type="text" id="tailor-name" placeholder="e.g. John Doe" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Quantity</label>
                                    <input type="number" id="tailor-quantity" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Cost per Unit (‚Ç¶)</label>
                                    <input type="number" id="tailor-cost" step="0.01" placeholder="0.00" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Date Contacted</label>
                                    <input type="date" id="tailor-contacted" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Promised Delivery Date</label>
                                    <input type="date" id="tailor-promised" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Actual Delivery Date (Optional)</label>
                                    <input type="date" id="tailor-delivered" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="button" id="cancel-tailor" class="flex-1 bg-slate-100 text-slate-600 p-3 rounded-xl font-bold">Cancel</button>
                                    <button type="submit" class="flex-1 btn-gradient text-white p-3 rounded-xl font-bold">Add Task</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ANALYTICS VIEW -->
                    <div id="analytics-view" class="hidden">
                        <div class="mb-6 space-y-4">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Analytics Dashboard</h3>
                                <p class="text-slate-500 text-sm">Unit costs and performance metrics.</p>
                            </div>
                            
                            <!-- P&L Report Section -->
                            <div class="glass-card p-6 rounded-3xl shadow-xl border-2 border-emerald-200">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h4 class="text-xl font-bold text-emerald-900">Monthly P&L Report</h4>
                                        <p class="text-xs text-slate-500">Automated on 1st of each month for tax reporting</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="generate-pl-report" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">Generate Report</button>
                                        <button id="download-pl-pdf" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hidden">Save as PDF</button>
                                    </div>
                                </div>
                                
                                <!-- Date Range Picker -->
                                <div class="grid grid-cols-2 gap-4 mt-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Start Date</label>
                                        <input type="date" id="pl-start-date" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg outline-none text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">End Date</label>
                                        <input type="date" id="pl-end-date" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg outline-none text-sm">
                                    </div>
                                </div>
                                
                                <div id="pl-report-content" class="mt-4"></div>
                            </div>
                        </div>
                        
                        <div id="analytics-content" class="space-y-6"></div>
                    </div>

                    <!-- USER MANAGEMENT VIEW -->
                    <div id="users-view" class="hidden">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">User Management</h3>
                                <p class="text-slate-500 text-sm">Manage user access and permissions.</p>
                            </div>
                            <button id="add-user-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">+ Add User</button>
                        </div>
                        <div id="users-list" class="space-y-4"></div>
                    </div>

                    <!-- ADD USER MODAL -->
                    <div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
                            <h3 class="text-2xl font-bold mb-6">Add New User</h3>
                            <form id="user-form" class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Email Address</label>
                                    <input type="email" id="user-email" placeholder="user@example.com" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Access Level</label>
                                    <select id="user-role" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" required>
                                        <option value="">Select access level</option>
                                        <option value="admin">Full Access (Admin)</option>
                                        <option value="viewer">Catalog Only (Viewer)</option>
                                    </select>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-xl">
                                    <p class="text-xs text-blue-800">
                                        <strong>Full Access:</strong> Can manage inventory, expenses, tailors, and view analytics.<br>
                                        <strong>Catalog Only:</strong> Can only view and manage catalog items (no financial data).
                                    </p>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="button" id="cancel-user" class="flex-1 bg-slate-100 text-slate-600 p-3 rounded-xl font-bold">Cancel</button>
                                    <button type="submit" class="flex-1 btn-gradient text-white p-3 rounded-xl font-bold">Add User</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- EDIT ITEM MODAL -->
                    <div id="edit-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <h3 class="text-2xl font-bold mb-6">Edit Item</h3>
                            <form id="edit-item-form" class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Item Name</label>
                                    <input type="text" id="edit-item-name" placeholder="e.g. Silk Blazer" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Serial/Code</label>
                                    <input type="text" id="edit-item-code" placeholder="RS-001" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Sleeve Type</label>
                                        <select id="edit-item-sleeve" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                            <option value="Long Sleeve">Long Sleeve</option>
                                            <option value="Short Sleeve">Short Sleeve</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Material</label>
                                        <input type="text" id="edit-item-material" placeholder="e.g. Plain, Patterned, Stripped" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Custom Made?</label>
                                    <select id="edit-item-custom" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Selling Price</label>
                                    <input type="number" id="edit-item-price" placeholder="‚Ç¶" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Size</label>
                                        <input type="text" id="edit-item-size" placeholder="e.g. M, L, XL" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Colour</label>
                                        <input type="text" id="edit-item-colour" placeholder="e.g. Red, Blue" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Product Photo (Optional)</label>
                                    <input type="file" id="edit-item-image" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                    <div id="edit-item-image-preview" class="mt-2"></div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="button" id="cancel-edit-item" class="flex-1 bg-slate-100 text-slate-600 p-3 rounded-xl font-bold">Cancel</button>
                                    <button type="submit" class="flex-1 btn-gradient text-white p-3 rounded-xl font-bold">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- HELP TIPS TOOLTIP -->
        <div id="help-tooltip" class="fixed bottom-6 right-6 z-50">
            <button id="help-btn" class="bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center font-bold text-xl hover:bg-indigo-700 transition-all">
                ?
            </button>
        </div>

        <!-- HELP MODAL -->
        <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-6">
                    <h3 class="text-3xl font-bold">üìñ Quick Guide</h3>
                    <button id="close-help" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üéØ Getting Started</h4>
                        <ol class="text-sm space-y-2 list-decimal list-inside">
                            <li><strong>Create a Batch:</strong> Click "Batch Mgmt" tab ‚Üí Fill in batch details ‚Üí Click "Create Batch"</li>
                            <li><strong>Add Items:</strong> Click "New Item" tab ‚Üí Select your batch ‚Üí Add product details</li>
                            <li><strong>Track Expenses:</strong> Go to "Expenses" view ‚Üí Click "+ Add Expense" ‚Üí Select batch and enter costs</li>
                        </ol>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üíº Batch Management</h4>
                        <p class="text-sm mb-2">A batch represents a production run. For example, "Batch 003" with 50 shirts.</p>
                        <ul class="text-sm space-y-1 list-disc list-inside">
                            <li>Track how many are Long/Short sleeve</li>
                            <li>Track Plain vs Patterned materials</li>
                            <li>Mark custom-made items for premium pricing</li>
                        </ul>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üí∞ Expense Tracking</h4>
                        <p class="text-sm">Record all costs associated with each batch:</p>
                        <ul class="text-sm space-y-1 list-disc list-inside mt-2">
                            <li><strong>Material:</strong> Fabric and supplies costs</li>
                            <li><strong>Transport:</strong> Travel expenses for material sourcing</li>
                            <li><strong>Waybill:</strong> Shipping costs from Aba to Lagos</li>
                            <li><strong>Ironing/Mending:</strong> Post-production costs</li>
                            <li><strong>Other:</strong> Custom expense categories with your own names</li>
                        </ul>
                    </div>

                    <div class="bg-amber-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">‚úÇÔ∏è Tailor Management</h4>
                        <p class="text-sm mb-2">Track work assigned to different tailors:</p>
                        <ul class="text-sm space-y-1 list-disc list-inside">
                            <li>Assign specific quantities to each tailor</li>
                            <li>Set promised delivery dates</li>
                            <li>Mark when items are received</li>
                            <li>Late deliveries are automatically flagged ‚ö†Ô∏è</li>
                            <li>Toggle payment status: Pending ‚Üî Paid</li>
                        </ul>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üìä Item Status Flow</h4>
                        <p class="text-sm mb-2">Items move through three stages:</p>
                        <div class="flex items-center gap-2 text-sm mt-2">
                            <span class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded-full font-bold text-xs">AVAILABLE</span>
                            <span>‚Üí</span>
                            <span class="px-3 py-1 bg-amber-100 text-amber-600 rounded-full font-bold text-xs">DELIVERED</span>
                            <span>‚Üí</span>
                            <span class="px-3 py-1 bg-rose-100 text-rose-600 rounded-full font-bold text-xs">SOLD</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Use DELIV button when item is delivered but payment is pending</p>
                    </div>

                    <div class="bg-rose-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üìà Analytics Dashboard</h4>
                        <p class="text-sm">View real-time metrics for each batch:</p>
                        <ul class="text-sm space-y-1 list-disc list-inside mt-2">
                            <li><strong>Unit Cost:</strong> Total Costs √∑ Total Shirts</li>
                            <li><strong>Revenue:</strong> Sum of all sold items</li>
                            <li><strong>Profit/Loss:</strong> Revenue minus proportional costs</li>
                            <li><strong>Monthly P&L:</strong> Automated reports on 1st of each month for tax</li>
                            <li>Track sales progress and tailor performance</li>
                        </ul>
                    </div>

                    <div class="bg-slate-100 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üí° Pro Tips</h4>
                        <ul class="text-sm space-y-1 list-disc list-inside">
                            <li>Create batches first before adding individual items</li>
                            <li>Add all expenses as they occur for accurate unit costs</li>
                            <li>Use the Analytics view to identify profitable batches</li>
                            <li>Export sold items to PDF for record keeping</li>
                            <li>Add multiple material sources for complex items</li>
                            <li>Generate custom P&L reports for specific date ranges</li>
                            <li>Use Excel bulk import to add multiple items quickly</li>
                        </ul>
                    </div>
                </div>

                <button id="close-help-btn" class="w-full mt-6 btn-gradient text-white p-3 rounded-xl font-bold">Got it!</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, getDocs, getDoc, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDr51BYzXFgalvJAAB7qkWaOUHdYmt_btw",
            authDomain: "real-stitch.firebaseapp.com",
            projectId: "real-stitch",
            storageBucket: "real-stitch.firebasestorage.app",
            messagingSenderId: "447530536159",
            appId: "1:447530536159:web:d1502bdafcd1892ef02d6a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Main admin emails
        const MAIN_ADMINS = [
            'bukkyugwu@gmail.com',
            'davidfestusugwu@gmail.com',
            'realstitchfashion@gmail.com',
            'festusugwu@gmail.com'
        ];

        let currentUserRole = null;
        let currentUserEmail = null;

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUserEmail = user.email;
                
                // Check if user has access
                const hasAccess = await checkUserAccess(user.email);
                
                if (!hasAccess) {
                    alert('You do not have access to this system. Please contact an administrator.');
                    signOut(auth);
                    return;
                }
                
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Apply role-based UI restrictions
                applyRoleRestrictions();
                
                loadTypes();
                loadInventory();
                loadBatches();
                setupTabSwitching();
                setupViewSwitching();
                setupCatalogFilter();
                setupExpenseCategory();
                setupPLReport();
                setupBulkExcelImport();
                setupCatalogSearch();
                
                if (currentUserRole === 'admin') {
                    loadUsersView();
                }
            } else {
                currentUserRole = null;
                currentUserEmail = null;
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        async function checkUserAccess(email) {
            // Main admins always have access
            if (MAIN_ADMINS.includes(email.toLowerCase())) {
                currentUserRole = 'admin';
                return true;
            }
            
            // Check if user exists in users collection
            const usersSnap = await getDocs(query(collection(db, "users"), where("email", "==", email.toLowerCase())));
            
            if (usersSnap.empty) {
                return false;
            }
            
            const userData = usersSnap.docs[0].data();
            currentUserRole = userData.role;
            return true;
        }

        function applyRoleRestrictions() {
            if (currentUserRole === 'viewer') {
                // Hide all views except catalog
                document.getElementById('view-batches').style.display = 'none';
                document.getElementById('view-expenses').style.display = 'none';
                document.getElementById('view-tailors').style.display = 'none';
                document.getElementById('view-analytics').style.display = 'none';
                
                // Hide batch management and new item tabs
                document.getElementById('tab-batch').style.display = 'none';
                document.getElementById('tab-item').style.display = 'none';
                document.querySelector('.lg\\:col-span-1').style.display = 'none';
                
                // Show only catalog
                document.getElementById('catalog-view').classList.remove('hidden');
                
                // Hide pricing column in catalog
                const style = document.createElement('style');
                style.innerHTML = `
                    .viewer-hide-price { display: none !important; }
                `;
                document.head.appendChild(style);
            } else if (currentUserRole === 'admin') {
                // Show user management button for admins
                document.getElementById('view-users').classList.remove('hidden');
            }
        }

        function loadTypes() {
            onSnapshot(collection(db, "types"), (snap) => {
                const select = document.getElementById('item-type-select');
                if (select) {
                    select.innerHTML = '<option value="">Select</option>';
                    snap.forEach(d => {
                        select.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`;
                    });
                }
            });
        }

        // Show/Hide Custom Expense Name
        function setupExpenseCategory() {
            const categorySelect = document.getElementById('expense-category');
            const customNameContainer = document.getElementById('custom-expense-name-container');
            
            categorySelect.onchange = () => {
                if (categorySelect.value === 'Other') {
                    customNameContainer.classList.remove('hidden');
                } else {
                    customNameContainer.classList.add('hidden');
                }
            };
        }

        // P&L Report Generation
        function setupPLReport() {
            const today = new Date();
            const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            
            document.getElementById('pl-start-date').valueAsDate = firstDayLastMonth;
            document.getElementById('pl-end-date').valueAsDate = lastDayLastMonth;
            
            document.getElementById('generate-pl-report').onclick = generatePLReport;
            document.getElementById('download-pl-pdf').onclick = downloadPLReportAsPDF;
        }

        let currentPLData = null;

        async function generatePLReport() {
            const startDate = new Date(document.getElementById('pl-start-date').value);
            const endDate = new Date(document.getElementById('pl-end-date').value);
            endDate.setHours(23, 59, 59, 999);
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const reportContent = document.getElementById('pl-report-content');
            reportContent.innerHTML = '<div class="text-center py-4">Generating report...</div>';
            
            const inventorySnap = await getDocs(collection(db, "inventory"));
            const soldItems = [];
            let totalRevenue = 0;
            
            inventorySnap.forEach(d => {
                const item = d.data();
                if (item.status === 'sold' && item.soldDate) {
                    const soldDate = item.soldDate.toDate();
                    if (soldDate >= startDate && soldDate <= endDate) {
                        soldItems.push({...item, id: d.id});
                        totalRevenue += parseFloat(item.price || 0);
                    }
                }
            });
            
            const expensesSnap = await getDocs(collection(db, "expenses"));
            let totalExpenses = 0;
            const expensesByBatch = {};
            
            expensesSnap.forEach(d => {
                const exp = d.data();
                const amount = parseFloat(exp.amount || 0);
                totalExpenses += amount;
                if (!expensesByBatch[exp.batchId]) {
                    expensesByBatch[exp.batchId] = 0;
                }
                expensesByBatch[exp.batchId] += amount;
            });
            
            const tailorsSnap = await getDocs(collection(db, "tailors"));
            let totalTailorCosts = 0;
            const tailorCostsByBatch = {};
            
            tailorsSnap.forEach(d => {
                const tailor = d.data();
                const cost = tailor.quantity * tailor.costPerUnit;
                totalTailorCosts += cost;
                if (!tailorCostsByBatch[tailor.batchId]) {
                    tailorCostsByBatch[tailor.batchId] = 0;
                }
                tailorCostsByBatch[tailor.batchId] += cost;
            });
            
            const batchesSnap = await getDocs(collection(db, "batches"));
            const batches = {};
            batchesSnap.forEach(d => {
                batches[d.id] = d.data();
            });
            
            let proportionalCosts = 0;
            soldItems.forEach(item => {
                const batchId = item.batchId;
                if (batches[batchId]) {
                    const batchExpenses = (expensesByBatch[batchId] || 0) + (tailorCostsByBatch[batchId] || 0);
                    const unitCost = batchExpenses / batches[batchId].totalShirts;
                    proportionalCosts += unitCost;
                }
            });
            
            const netProfit = totalRevenue - proportionalCosts;
            
            currentPLData = {
                startDate,
                endDate,
                soldItems,
                totalRevenue,
                proportionalCosts,
                netProfit
            };
            
            document.getElementById('download-pl-pdf').classList.remove('hidden');
            
            reportContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl border-2 border-slate-200">
                    <div class="text-center mb-6">
                        <h5 class="text-lg font-bold text-slate-700">Profit & Loss Statement</h5>
                        <p class="text-xs text-slate-500">${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold">Items Sold:</span>
                            <span class="font-bold">${soldItems.length}</span>
                        </div>
                        
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold">Total Revenue:</span>
                            <span class="font-bold text-emerald-600">‚Ç¶${totalRevenue.toFixed(2)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold">Cost of Goods Sold:</span>
                            <span class="font-bold text-rose-600">-‚Ç¶${proportionalCosts.toFixed(2)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center bg-${netProfit >= 0 ? 'emerald' : 'rose'}-50 p-4 rounded-lg mt-4">
                            <span class="font-bold text-lg">Net ${netProfit >= 0 ? 'Profit' : 'Loss'}:</span>
                            <span class="font-bold text-2xl text-${netProfit >= 0 ? 'emerald' : 'rose'}-600">‚Ç¶${Math.abs(netProfit).toFixed(2)}</span>
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-800"><strong>Tax Note:</strong> This report shows profit from items sold in the selected period. Consult your tax advisor for proper tax calculation.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function downloadPLReportAsPDF() {
            if (!currentPLData) {
                alert('Please generate a report first');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const { startDate, endDate, soldItems, totalRevenue, proportionalCosts, netProfit } = currentPLData;

            // Enhanced Header with gradient effect
            pdf.setFillColor(79, 70, 229);
            pdf.rect(0, 0, 210, 50, 'F');
            
            // White accent line
            pdf.setFillColor(255, 255, 255);
            pdf.rect(0, 48, 210, 2, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(36);
            pdf.setFont(undefined, 'bold');
            pdf.text("REAL STITCH", 105, 22, { align: 'center' });
            
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'normal');
            pdf.text("Profit & Loss Statement", 105, 32, { align: 'center' });
            
            pdf.setFontSize(11);
            pdf.text(`Reporting Period: ${startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`, 105, 42, { align: 'center' });

            let yPos = 65;
            
            // Financial Summary Card with border
            pdf.setDrawColor(226, 232, 240);
            pdf.setLineWidth(0.5);
            pdf.setFillColor(248, 250, 252);
            pdf.rect(14, yPos, 182, 65, 'FD');
            
            pdf.setTextColor(30, 41, 59);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text("üìä FINANCIAL SUMMARY", 20, yPos + 12);
            
            // Divider line
            pdf.setDrawColor(203, 213, 225);
            pdf.setLineWidth(0.3);
            pdf.line(20, yPos + 18, 190, yPos + 18);
            
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            
            // Items Sold
            pdf.setTextColor(71, 85, 105);
            pdf.text(`Items Sold:`, 25, yPos + 30);
            pdf.setTextColor(30, 41, 59);
            pdf.setFont(undefined, 'bold');
            pdf.text(`${soldItems.length}`, 190, yPos + 30, { align: 'right' });
            
            // Total Revenue
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(71, 85, 105);
            pdf.text(`Total Revenue:`, 25, yPos + 40);
            pdf.setTextColor(16, 185, 129);
            pdf.setFont(undefined, 'bold');
            pdf.setFontSize(12);
            pdf.text(`‚Ç¶${totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 190, yPos + 40, { align: 'right' });
            
            // Cost of Goods Sold
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(71, 85, 105);
            pdf.text(`Cost of Goods Sold:`, 25, yPos + 50);
            pdf.setTextColor(239, 68, 68);
            pdf.setFont(undefined, 'bold');
            pdf.setFontSize(12);
            pdf.text(`‚Ç¶${proportionalCosts.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 190, yPos + 50, { align: 'right' });

            yPos += 75;
            
            // Net Profit/Loss Highlight Box
            const profitColor = netProfit >= 0 ? [16, 185, 129] : [239, 68, 68];
            pdf.setFillColor(...profitColor);
            pdf.rect(14, yPos, 182, 25, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text(`NET ${netProfit >= 0 ? 'PROFIT' : 'LOSS'}:`, 20, yPos + 16);
            pdf.setFontSize(20);
            pdf.text(`‚Ç¶${Math.abs(netProfit).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 190, yPos + 16, { align: 'right' });

            if (soldItems.length > 0) {
                yPos += 40;
                
                pdf.setTextColor(30, 41, 59);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text("üìã ITEMS SOLD DETAIL", 20, yPos);
                
                yPos += 8;

                const rows = soldItems.map(item => [
                    item.name || 'N/A',
                    item.code || 'N/A',
                    `${item.sleeveType || ''} ${item.material || ''}`.trim() || 'N/A',
                    `‚Ç¶${parseFloat(item.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                ]);

                pdf.autoTable({
                    head: [['Product Name', 'Code', 'Type', 'Price']],
                    body: rows,
                    startY: yPos,
                    margin: { left: 14, right: 14 },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 11,
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 10,
                        textColor: [51, 65, 85],
                        cellPadding: 3
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 75, fontStyle: 'bold' },
                        1: { cellWidth: 40, halign: 'center' },
                        2: { cellWidth: 50, halign: 'center' },
                        3: { cellWidth: 27, halign: 'right', fontStyle: 'bold', textColor: [16, 185, 129] }
                    },
                    styles: {
                        lineColor: [226, 232, 240],
                        lineWidth: 0.3
                    }
                });
            }

            // Footer on all pages
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                
                // Footer line
                pdf.setDrawColor(226, 232, 240);
                pdf.setLineWidth(0.5);
                pdf.line(14, 280, 196, 280);
                
                pdf.setFontSize(9);
                pdf.setTextColor(148, 163, 184);
                pdf.text(`Generated on ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} at ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`, 105, 285, { align: 'center' });
                pdf.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
            }

            pdf.save(`PL_Report_${startDate.toLocaleDateString().replace(/\//g, '-')}_to_${endDate.toLocaleDateString().replace(/\//g, '-')}.pdf`);
        }

        // Bulk Excel Import
        function setupBulkExcelImport() {
            document.getElementById('process-excel-btn').onclick = processExcelImport;
        }

        async function processExcelImport() {
            const batchId = document.getElementById('item-batch').value;
            if (!batchId) {
                alert('Please select a batch first before importing items!');
                return;
            }

            const fileInput = document.getElementById('bulk-excel');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an Excel file to import');
                return;
            }

            const btn = document.getElementById('process-excel-btn');
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    alert('No data found in Excel file');
                    btn.innerText = "Import from Excel";
                    btn.disabled = false;
                    return;
                }

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    try {
                        const itemName = row['Item Name'] || row['item name'] || row['Name'] || row['name'] || '';
                        const code = row['Code'] || row['code'] || row['Serial'] || row['serial'] || '';
                        const sleeveType = String(
                            row['Sleeve Type (long/short)'] || 
                            row['Sleeve Type (LS/SS)'] || 
                            row['Sleeve Type'] || 
                            row['sleeve type'] || 
                            row['Sleeve'] || 
                            row['sleeve'] || 
                            ''
                        ).trim();
                        const material = String(
                            row['Material (Plain/Patterned)'] || 
                            row['Material'] || 
                            row['material'] || 
                            row['MATERIAL'] ||
                            row['Material (long/short)'] ||
                            ''
                        ).trim();
                        const customMade = String(
                            row['Custom Made (Yes/No)'] || 
                            row['Custom Made'] || 
                            row['custom made'] || 
                            row['Custom'] || 
                            row['custom'] || 
                            'No'
                        ).trim();
                        const price = row['Selling Price'] || row['selling price'] || row['Price'] || row['price'] || 0;
                        const size = String(
                            row['Size'] || 
                            row['size'] || 
                            row['SIZE'] || 
                            ''
                        ).trim();
                        const colour = String(
                            row['Colour'] || 
                            row['colour'] || 
                            row['Color'] || 
                            row['color'] || 
                            row['COLOUR'] || 
                            row['COLOR'] || 
                            ''
                        ).trim();

                        if (!itemName || !code || !price) {
                            errors.push(`Row ${i + 2}: Missing required fields (Item Name, Code, or Price)`);
                            errorCount++;
                            continue;
                        }

                        // Normalize sleeve type
                        let normalizedSleeveType = 'Long Sleeve'; // Default
                        if (sleeveType !== '') {
                            const sleeveUpper = sleeveType.toUpperCase();
                            const sleeveLower = sleeveType.toLowerCase();
                            
                            if (sleeveUpper === 'SS' || sleeveUpper === 'SHORT SLEEVE' || sleeveUpper === 'SHORT' || sleeveLower === 'short' || sleeveLower === 'ss') {
                                normalizedSleeveType = 'Short Sleeve';
                            } else if (sleeveUpper === 'LS' || sleeveUpper === 'LONG SLEEVE' || sleeveUpper === 'LONG' || sleeveLower === 'long' || sleeveLower === 'ls') {
                                normalizedSleeveType = 'Long Sleeve';
                            } else {
                                // Unrecognized sleeve type
                                errors.push(`Row ${i + 2}: Warning - Unrecognized sleeve type "${sleeveType}", defaulting to Long Sleeve`);
                            }
                        } else {
                            // Fallback: infer from product code (e.g. B1-017S = short, B1-018L = long)
                            const codeStr = String(code).trim();
                            const lastChar = codeStr.slice(-1).toUpperCase();
                            if (lastChar === 'S') normalizedSleeveType = 'Short Sleeve';
                            else if (lastChar === 'L') normalizedSleeveType = 'Long Sleeve';
                        }

                        // Use material as-is (no normalization)
                        let normalizedMaterial = material || '';

                        // Normalize custom made
                        let normalizedCustom = 'No';
                        const customLower = customMade.toLowerCase();
                        if (customLower === 'yes' || customLower === 'y' || customMade === '1' || customLower === 'true') {
                            normalizedCustom = 'Yes';
                        }

                        await addDoc(collection(db, "inventory"), {
                            batchId: batchId,
                            name: itemName.toString().trim(),
                            code: code.toString().trim(),
                            sleeveType: normalizedSleeveType,
                            material: normalizedMaterial,
                            materialSources: [],
                            customMade: normalizedCustom,
                            price: parseFloat(price),
                            size: size || "",
                            colour: colour || "",
                            image: "",
                            status: 'available',
                            createdAt: new Date(),
                            soldDate: null
                        });

                        successCount++;
                    } catch (error) {
                        errors.push(`Row ${i + 2}: ${error.message}`);
                        errorCount++;
                    }
                }

                let message = `Import completed!\n\nSuccessfully imported: ${successCount} items`;
                if (errorCount > 0) {
                    message += `\nFailed: ${errorCount} items\n\nErrors:\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) {
                        message += `\n... and ${errors.length - 5} more errors`;
                    }
                }
                
                alert(message);
                fileInput.value = '';

            } catch (error) {
                alert('Error processing Excel file: ' + error.message);
            } finally {
                btn.innerText = "Import from Excel";
                btn.disabled = false;
            }
        }

        // TAB SWITCHING
        function setupTabSwitching() {
            const tabBatch = document.getElementById('tab-batch');
            const tabItem = document.getElementById('tab-item');
            const batchContainer = document.getElementById('batch-form-container');
            const itemContainer = document.getElementById('item-form-container');

            tabBatch.onclick = () => {
                tabBatch.classList.add('bg-indigo-500', 'text-white');
                tabBatch.classList.remove('bg-slate-100', 'text-slate-600');
                tabItem.classList.remove('bg-indigo-500', 'text-white');
                tabItem.classList.add('bg-slate-100', 'text-slate-600');
                batchContainer.classList.remove('hidden');
                itemContainer.classList.add('hidden');
            };

            tabItem.onclick = () => {
                tabItem.classList.add('bg-indigo-500', 'text-white');
                tabItem.classList.remove('bg-slate-100', 'text-slate-600');
                tabBatch.classList.remove('bg-indigo-500', 'text-white');
                tabBatch.classList.add('bg-slate-100', 'text-slate-600');
                itemContainer.classList.remove('hidden');
                batchContainer.classList.add('hidden');
            };
        }

        // VIEW SWITCHING
        function setupViewSwitching() {
            const views = {
                'view-catalog': 'catalog-view',
                'view-batches': 'batches-view',
                'view-expenses': 'expenses-view',
                'view-tailors': 'tailors-view',
                'view-analytics': 'analytics-view',
                'view-users': 'users-view'
            };

            Object.keys(views).forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (!btn) return;
                
                btn.onclick = () => {
                    Object.values(views).forEach(v => document.getElementById(v).classList.add('hidden'));
                    document.getElementById(views[btnId]).classList.remove('hidden');
                    
                    Object.keys(views).forEach(id => {
                        const button = document.getElementById(id);
                        if (button) {
                            button.classList.remove('bg-slate-800', 'text-white');
                            if (id === btnId) {
                                button.classList.add('bg-slate-800', 'text-white');
                            }
                        }
                    });

                    if (btnId === 'view-batches') loadBatchesView();
                    if (btnId === 'view-expenses') loadExpensesView();
                    if (btnId === 'view-tailors') loadTailorsView();
                    if (btnId === 'view-analytics') loadAnalyticsView();
                    if (btnId === 'view-users') loadUsersView();
                };
            });
        }

        // BATCH FORM
        document.getElementById('batch-form').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "batches"), {
                name: document.getElementById('batch-name').value,
                totalShirts: parseInt(document.getElementById('batch-total').value),
                longSleeve: parseInt(document.getElementById('batch-long').value) || 0,
                shortSleeve: parseInt(document.getElementById('batch-short').value) || 0,
                plain: parseInt(document.getElementById('batch-plain').value) || 0,
                patterned: parseInt(document.getElementById('batch-patterned').value) || 0,
                customMade: parseInt(document.getElementById('batch-custom').value) || 0,
                createdAt: new Date()
            });
            e.target.reset();
            alert('Batch created successfully!');
        };

        // LOAD BATCHES
        function loadBatches() {
            onSnapshot(collection(db, "batches"), (snap) => {
                const selects = ['item-batch', 'expense-batch', 'tailor-batch', 'catalog-batch-filter'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const isFilter = selectId === 'catalog-batch-filter';
                        select.innerHTML = isFilter ? '<option value="">All Batches</option>' : '<option value="">Select Batch</option>';
                        snap.forEach(d => {
                            select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
                        });
                    }
                });
            });
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        document.getElementById('inventory-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Processing...";
            btn.disabled = true;

            const file = document.getElementById('item-image').files[0];
            let imageBase64 = "";
            if (file) imageBase64 = await toBase64(file);

            await addDoc(collection(db, "inventory"), {
                batchId: document.getElementById('item-batch').value,
                name: document.getElementById('item-name').value,
                code: document.getElementById('item-code').value,
                sleeveType: document.getElementById('item-sleeve').value,
                material: document.getElementById('item-material').value,
                materialSources: [],
                customMade: document.getElementById('item-custom').value,
                price: document.getElementById('item-price').value,
                size: document.getElementById('item-size').value || "",
                colour: document.getElementById('item-colour').value || "",
                image: imageBase64,
                status: 'available',
                createdAt: new Date(),
                soldDate: null
            });

            btn.innerText = "Save to Collection";
            btn.disabled = false;
            e.target.reset();
        };

        function loadInventory() {
            const q = query(collection(db, "inventory"), orderBy("createdAt", "desc"));
            onSnapshot(q, async (inventorySnap) => {
                const batchesSnap = await getDocs(collection(db, "batches"));
                const batches = {};
                batchesSnap.forEach(d => {
                    batches[d.id] = d.data().name;
                });

                const itemsByBatch = {};
                inventorySnap.forEach(d => {
                    const item = d.data();
                    const batchId = item.batchId || 'no-batch';
                    if (!itemsByBatch[batchId]) {
                        itemsByBatch[batchId] = [];
                    }
                    itemsByBatch[batchId].push({id: d.id, ...item});
                });

                const filterValue = document.getElementById('catalog-batch-filter')?.value || '';
                const searchValue = document.getElementById('catalog-search')?.value.toLowerCase() || '';
                
                const container = document.getElementById('catalog-by-batches');
                container.innerHTML = "";

                Object.keys(itemsByBatch).forEach(batchId => {
                    if (filterValue && filterValue !== batchId) return;

                    const batchName = batches[batchId] || 'Unassigned Items';
                    let items = itemsByBatch[batchId];
                    
                    // Apply search filter
                    if (searchValue) {
                        items = items.filter(item => 
                            item.name.toLowerCase().includes(searchValue) || 
                            item.code.toLowerCase().includes(searchValue)
                        );
                    }
                    
                    if (items.length === 0) return; // Skip if no items match
                    
                    container.innerHTML += `
                        <div class="mb-8">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="h-1 w-12 bg-indigo-500 rounded-full"></div>
                                <h4 class="text-2xl font-bold text-slate-800">${batchName}</h4>
                                <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">${items.length} items</span>
                            </div>
                            
                            <div class="glass-card rounded-3xl shadow-xl overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left min-w-[1200px]">
                                    <thead class="bg-slate-50/50 border-b border-slate-100 text-slate-400 text-[10px] font-bold uppercase tracking-widest">
                                        <tr>
                                            <th class="p-3 whitespace-nowrap">Visual</th>
                                            <th class="p-3 whitespace-nowrap min-w-[120px]">Item Name</th>
                                            <th class="p-3 whitespace-nowrap min-w-[100px]">Code</th>
                                            <th class="p-3 whitespace-nowrap min-w-[110px]">Sleeve Type</th>
                                            <th class="p-3 whitespace-nowrap min-w-[100px]">Material</th>
                                            <th class="p-3 whitespace-nowrap min-w-[110px]">Custom Made</th>
                                            <th class="p-3 whitespace-nowrap min-w-[110px]">Selling Price</th>
                                            <th class="p-3 whitespace-nowrap min-w-[80px]">Size</th>
                                            <th class="p-3 whitespace-nowrap min-w-[100px]">Colour</th>
                                            <th class="p-3 whitespace-nowrap min-w-[100px]">Status</th>
                                            <th class="p-3 text-right whitespace-nowrap min-w-[280px]">Control</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${items.map(item => `
                                            <tr class="table-row-hover transition-colors">
                                                <td class="p-3">
                                                    <div class="w-16 h-16 rounded-2xl border-2 border-white shadow-sm overflow-hidden bg-slate-100">
                                                        <img src="${item.image || 'https://via.placeholder.com/64'}" class="w-full h-full object-cover">
                                                    </div>
                                                </td>
                                                <td class="p-3">
                                                    <div class="font-bold text-slate-800 whitespace-nowrap">${item.name || 'N/A'}</div>
                                                </td>
                                                <td class="p-3">
                                                    <div class="text-xs font-semibold text-slate-600 whitespace-nowrap">${item.code || 'N/A'}</div>
                                                </td>
                                                <td class="p-3">
                                                    <div class="text-xs font-semibold text-slate-500 whitespace-nowrap">${item.sleeveType || 'N/A'}</div>
                                                </td>
                                                <td class="p-3">
                                                    <div class="text-xs font-semibold text-slate-500 whitespace-nowrap">${item.material || 'N/A'}</div>
                                                </td>
                                                <td class="p-3">
                                                    <span class="px-2 py-1 rounded-full text-[10px] font-bold whitespace-nowrap ${item.customMade === 'Yes' ? 'bg-purple-100 text-purple-600' : 'bg-slate-100 text-slate-600'}">
                                                        ${item.customMade || 'No'}
                                                    </span>
                                                </td>
                                                <td class="p-3">
                                                    <div class="text-indigo-600 font-bold whitespace-nowrap ${currentUserRole === 'viewer' ? 'viewer-hide-price' : ''}">‚Ç¶${item.price || '0'}</div>
                                                </td>
                                                <td class="p-3">
                                                    <div class="text-xs font-semibold text-slate-600 whitespace-nowrap">${item.size || 'N/A'}</div>
                                                </td>
                                                <td class="p-3">
                                                    <div class="text-xs font-semibold text-slate-600 whitespace-nowrap">${item.colour || 'N/A'}</div>
                                                </td>
                                                <td class="p-3">
                                                    <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase whitespace-nowrap ${item.status === 'sold' ? 'bg-rose-100 text-rose-600' : item.status === 'delivered' ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}">
                                                        ${item.status}
                                                    </span>
                                                </td>
                                                <td class="p-3 text-right">
                                                    <div class="flex justify-end gap-2 flex-nowrap">
                                                        <button onclick="window.editItem('${item.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold whitespace-nowrap">EDIT</button>
                                                        <button onclick="window.setStatus('${item.id}', 'available')" class="hover:bg-emerald-50 p-2 rounded-lg transition-colors text-emerald-600 font-bold text-[10px] whitespace-nowrap">AVAIL</button>
                                                        <button onclick="window.setStatus('${item.id}', 'delivered')" class="hover:bg-amber-50 p-2 rounded-lg transition-colors text-amber-600 font-bold text-[10px] whitespace-nowrap">DELIV</button>
                                                        <button onclick="window.setStatus('${item.id}', 'sold')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-[10px] font-bold whitespace-nowrap">SOLD</button>
                                                        <button onclick="window.delItem('${item.id}')" class="text-slate-300 hover:text-rose-500 transition-colors whitespace-nowrap">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (container.innerHTML === "") {
                    container.innerHTML = `
                        <div class="glass-card rounded-3xl shadow-xl p-12 text-center">
                            <div class="text-6xl mb-4">üì¶</div>
                            <h3 class="text-2xl font-bold text-slate-700 mb-2">No Items Yet</h3>
                            <p class="text-slate-500">Start by creating a batch, then add items to your inventory.</p>
                        </div>
                    `;
                }
            });
        }

        function setupCatalogFilter() {
            const filterSelect = document.getElementById('catalog-batch-filter');
            if (filterSelect) {
                filterSelect.onchange = loadInventory;
            }
        }

        // NEW: Catalog Search Functionality
        function setupCatalogSearch() {
            const searchInput = document.getElementById('catalog-search');
            if (searchInput) {
                searchInput.oninput = loadInventory;
            }
        }

        window.setStatus = async (id, s) => {
            const updateData = { status: s };
            if (s === 'sold') {
                updateData.soldDate = new Date();
            }
            await updateDoc(doc(db, "inventory", id), updateData);
        };
        
        window.delItem = async (id) => { if(confirm("Permanently remove this item?")) await deleteDoc(doc(db, "inventory", id)); };

        let currentEditItemId = null;

        window.editItem = async (id) => {
            currentEditItemId = id;
            const itemDocRef = doc(db, "inventory", id);
            const itemDoc = await getDoc(itemDocRef);
            
            if (!itemDoc.exists()) {
                alert('Item not found');
                return;
            }
            
            const item = itemDoc.data();
            
            document.getElementById('edit-item-name').value = item.name || '';
            document.getElementById('edit-item-code').value = item.code || '';
            document.getElementById('edit-item-sleeve').value = item.sleeveType || 'Long Sleeve';
            document.getElementById('edit-item-material').value = item.material || '';
            document.getElementById('edit-item-custom').value = item.customMade || 'No';
            document.getElementById('edit-item-price').value = item.price || '';
            document.getElementById('edit-item-size').value = item.size || '';
            document.getElementById('edit-item-colour').value = item.colour || '';
            
            const previewDiv = document.getElementById('edit-item-image-preview');
            if (item.image) {
                previewDiv.innerHTML = `<img src="${item.image}" class="w-32 h-32 object-cover rounded-xl border-2 border-slate-200 mt-2" alt="Current image">`;
            } else {
                previewDiv.innerHTML = '';
            }
            
            document.getElementById('edit-item-modal').classList.remove('hidden');
        };

        document.getElementById('cancel-edit-item').onclick = () => {
            document.getElementById('edit-item-modal').classList.add('hidden');
            document.getElementById('edit-item-form').reset();
            document.getElementById('edit-item-image-preview').innerHTML = '';
            currentEditItemId = null;
        };

        document.getElementById('edit-item-modal').onclick = (e) => {
            if (e.target.id === 'edit-item-modal') {
                document.getElementById('edit-item-modal').classList.add('hidden');
                document.getElementById('edit-item-form').reset();
                document.getElementById('edit-item-image-preview').innerHTML = '';
                currentEditItemId = null;
            }
        };

        document.getElementById('edit-item-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentEditItemId) return;
            
            const btn = document.getElementById('edit-item-form').querySelector('button[type="submit"]');
            btn.innerText = "Saving...";
            btn.disabled = true;

            const file = document.getElementById('edit-item-image').files[0];
            let imageBase64 = null;
            if (file) {
                imageBase64 = await toBase64(file);
            }

            const updateData = {
                name: document.getElementById('edit-item-name').value,
                code: document.getElementById('edit-item-code').value,
                sleeveType: document.getElementById('edit-item-sleeve').value,
                material: document.getElementById('edit-item-material').value,
                customMade: document.getElementById('edit-item-custom').value,
                price: document.getElementById('edit-item-price').value,
                size: document.getElementById('edit-item-size').value || "",
                colour: document.getElementById('edit-item-colour').value || ""
            };

            if (imageBase64) {
                updateData.image = imageBase64;
            }

            await updateDoc(doc(db, "inventory", currentEditItemId), updateData);

            btn.innerText = "Save Changes";
            btn.disabled = false;
            document.getElementById('edit-item-modal').classList.add('hidden');
            document.getElementById('edit-item-form').reset();
            document.getElementById('edit-item-image-preview').innerHTML = '';
            currentEditItemId = null;
        };

        // BATCHES VIEW
        function loadBatchesView() {
            onSnapshot(query(collection(db, "batches"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('batches-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const batch = d.data();
                    list.innerHTML += `
                        <div class="glass-card p-6 rounded-3xl shadow-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-xl font-bold">${batch.name}</h4>
                                    <p class="text-sm text-slate-500">Total: ${batch.totalShirts} shirts</p>
                                    <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                                        <div class="bg-blue-50 p-2 rounded-lg"><strong>Long:</strong> ${batch.longSleeve}</div>
                                        <div class="bg-purple-50 p-2 rounded-lg"><strong>Short:</strong> ${batch.shortSleeve}</div>
                                        <div class="bg-amber-50 p-2 rounded-lg"><strong>Plain:</strong> ${batch.plain}</div>
                                        <div class="bg-pink-50 p-2 rounded-lg"><strong>Pattern:</strong> ${batch.patterned}</div>
                                        <div class="bg-green-50 p-2 rounded-lg col-span-2"><strong>Custom:</strong> ${batch.customMade}</div>
                                    </div>
                                </div>
                                <button onclick="window.viewBatchDetails('${d.id}')" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold">Details</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.viewBatchDetails = (batchId) => {
            alert('Batch details coming soon! ID: ' + batchId);
        };

        // EXPENSES VIEW
        function loadExpensesView() {
            onSnapshot(collection(db, "expenses"), (snap) => {
                const list = document.getElementById('expenses-list');
                const expensesByBatch = {};
                
                snap.forEach(d => {
                    const exp = d.data();
                    if (!expensesByBatch[exp.batchId]) {
                        expensesByBatch[exp.batchId] = [];
                    }
                    expensesByBatch[exp.batchId].push({id: d.id, ...exp});
                });

                list.innerHTML = "";
                Object.keys(expensesByBatch).forEach(batchId => {
                    const total = expensesByBatch[batchId].reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                    list.innerHTML += `
                        <div class="mb-6">
                            <h5 class="font-bold text-lg mb-2">Batch: ${batchId}</h5>
                            <div class="space-y-2">
                                ${expensesByBatch[batchId].map(e => `
                                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg">
                                        <div>
                                            <span class="font-semibold">${e.customName || e.category}</span>
                                            ${e.details ? `<span class="text-xs text-indigo-600 ml-2">(${e.details})</span>` : ''}
                                            <span class="text-xs text-slate-500 ml-2">${new Date(e.date?.toDate()).toLocaleDateString()}</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="font-bold text-indigo-600">‚Ç¶${e.amount}</span>
                                            <button onclick="window.delExpense('${e.id}')" class="text-rose-500 text-xs">Delete</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-2 text-right font-bold text-lg">Total: ‚Ç¶${total.toFixed(2)}</div>
                        </div>
                    `;
                });
            });
        }

        document.getElementById('add-expense-btn').onclick = async () => {
            document.getElementById('expense-modal').classList.remove('hidden');
        };

        document.getElementById('cancel-expense').onclick = () => {
            document.getElementById('expense-modal').classList.add('hidden');
            document.getElementById('expense-form').reset();
            document.getElementById('custom-expense-name-container').classList.add('hidden');
        };

        document.getElementById('expense-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const category = document.getElementById('expense-category').value;
            const customName = category === 'Other' ? document.getElementById('custom-expense-name').value : null;
            const details = document.getElementById('expense-details').value;
            
            await addDoc(collection(db, "expenses"), {
                batchId: document.getElementById('expense-batch').value,
                category: category,
                customName: customName,
                details: details,
                amount: parseFloat(document.getElementById('expense-amount').value),
                date: new Date()
            });

            document.getElementById('expense-modal').classList.add('hidden');
            document.getElementById('expense-form').reset();
            document.getElementById('custom-expense-name-container').classList.add('hidden');
        };

        window.delExpense = async (id) => {
            if (confirm("Delete this expense?")) {
                await deleteDoc(doc(db, "expenses", id));
            }
        };

        // TAILORS VIEW
        function loadTailorsView() {
            onSnapshot(query(collection(db, "tailors"), orderBy("dateContacted", "desc")), (snap) => {
                const list = document.getElementById('tailors-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const tailor = d.data();
                    const dateContacted = tailor.dateContacted?.toDate();
                    const promisedDate = tailor.promisedDate?.toDate();
                    const deliveredDate = tailor.deliveredDate?.toDate();
                    const isLate = !deliveredDate && promisedDate && new Date() > promisedDate;
                    const wasLate = deliveredDate && promisedDate && deliveredDate > promisedDate;

                    list.innerHTML += `
                        <div class="glass-card p-6 rounded-3xl shadow-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="text-lg font-bold">${tailor.tailorName}</h4>
                                    <p class="text-sm text-slate-500">Batch: ${tailor.batchId}</p>
                                    <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                                        <div><strong>Qty:</strong> ${tailor.quantity}</div>
                                        <div><strong>Cost/Unit:</strong> ‚Ç¶${tailor.costPerUnit}</div>
                                        <div class="col-span-2"><strong>Total:</strong> ‚Ç¶${(tailor.quantity * tailor.costPerUnit).toFixed(2)}</div>
                                    </div>
                                    <div class="mt-3 space-y-1 text-xs">
                                        <div><strong>Contacted:</strong> ${dateContacted ? dateContacted.toLocaleDateString() : 'N/A'}</div>
                                        <div><strong>Promised:</strong> ${promisedDate ? promisedDate.toLocaleDateString() : 'N/A'}</div>
                                        <div class="${(isLate || wasLate) ? 'text-rose-600 font-bold' : ''}">
                                            <strong>Delivered:</strong> ${deliveredDate ? deliveredDate.toLocaleDateString() : 'Not yet delivered'}
                                        </div>
                                        ${isLate ? '<div class="text-rose-600 font-bold">‚ö† OVERDUE</div>' : ''}
                                        ${wasLate ? '<div class="text-rose-600 font-bold">‚ö† WAS LATE</div>' : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <span class="px-3 py-1 rounded-full text-[10px] font-bold ${
                                        tailor.paymentStatus === 'Paid' ? 'bg-green-100 text-green-600' : 
                                        tailor.paymentStatus === 'Not Paid' ? 'bg-rose-100 text-rose-600' :
                                        'bg-amber-100 text-amber-600'
                                    }">
                                        ${tailor.paymentStatus}
                                    </span>
                                    <button onclick="window.cycleTailorStatus('${d.id}', '${tailor.paymentStatus}')" class="bg-indigo-500 text-white px-3 py-1 rounded-lg text-xs">
                                        Toggle Status
                                    </button>
                                    ${!deliveredDate ? `
                                        <button onclick="window.markDelivered('${d.id}')" class="bg-emerald-500 text-white px-3 py-1 rounded-lg text-xs">Mark Delivered</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        document.getElementById('add-tailor-btn').onclick = async () => {
            document.getElementById('tailor-modal').classList.remove('hidden');
        };

        document.getElementById('cancel-tailor').onclick = () => {
            document.getElementById('tailor-modal').classList.add('hidden');
            document.getElementById('tailor-form').reset();
        };

        document.getElementById('tailor-form').onsubmit = async (e) => {
            e.preventDefault();

            const deliveredDateValue = document.getElementById('tailor-delivered').value;

            await addDoc(collection(db, "tailors"), {
                batchId: document.getElementById('tailor-batch').value,
                tailorName: document.getElementById('tailor-name').value,
                quantity: parseInt(document.getElementById('tailor-quantity').value),
                costPerUnit: parseFloat(document.getElementById('tailor-cost').value),
                dateContacted: new Date(document.getElementById('tailor-contacted').value),
                promisedDate: new Date(document.getElementById('tailor-promised').value),
                deliveredDate: deliveredDateValue ? new Date(deliveredDateValue) : null,
                paymentStatus: 'Not Paid'
            });

            document.getElementById('tailor-modal').classList.add('hidden');
            document.getElementById('tailor-form').reset();
        };

        window.cycleTailorStatus = async (id, currentStatus) => {
            let newStatus;
            if (currentStatus === 'Not Paid') {
                newStatus = 'Delivered';
            } else if (currentStatus === 'Delivered') {
                newStatus = 'Paid';
            } else {
                newStatus = 'Not Paid';
            }
            await updateDoc(doc(db, "tailors", id), { paymentStatus: newStatus });
        };

        window.markDelivered = async (id) => {
            await updateDoc(doc(db, "tailors", id), { 
                deliveredDate: new Date(),
                paymentStatus: 'Delivered'
            });
        };

        // HELP MODAL
        document.getElementById('help-btn').onclick = () => {
            document.getElementById('help-modal').classList.remove('hidden');
        };

        document.getElementById('close-help').onclick = () => {
            document.getElementById('help-modal').classList.add('hidden');
        };

        document.getElementById('close-help-btn').onclick = () => {
            document.getElementById('help-modal').classList.add('hidden');
        };

        document.getElementById('show-full-help').onclick = () => {
            document.getElementById('help-modal').classList.remove('hidden');
        };

        document.getElementById('dismiss-tip').onclick = () => {
            document.getElementById('quick-tip').style.display = 'none';
        };

        document.getElementById('expense-modal').onclick = (e) => {
            if (e.target.id === 'expense-modal') {
                document.getElementById('expense-modal').classList.add('hidden');
            }
        };

        document.getElementById('tailor-modal').onclick = (e) => {
            if (e.target.id === 'tailor-modal') {
                document.getElementById('tailor-modal').classList.add('hidden');
            }
        };

        document.getElementById('help-modal').onclick = (e) => {
            if (e.target.id === 'help-modal') {
                document.getElementById('help-modal').classList.add('hidden');
            }
        };

        // ANALYTICS VIEW
        async function loadAnalyticsView() {
            const batchesSnap = await getDocs(collection(db, "batches"));
            const expensesSnap = await getDocs(collection(db, "expenses"));
            const tailorsSnap = await getDocs(collection(db, "tailors"));
            const inventorySnap = await getDocs(collection(db, "inventory"));

            const analytics = {};
            
            batchesSnap.forEach(d => {
                const batch = d.data();
                analytics[d.id] = {
                    name: batch.name,
                    totalShirts: batch.totalShirts,
                    expenses: 0,
                    tailorCosts: 0,
                    itemsSold: 0,
                    revenue: 0
                };
            });

            expensesSnap.forEach(d => {
                const exp = d.data();
                if (analytics[exp.batchId]) {
                    analytics[exp.batchId].expenses += parseFloat(exp.amount || 0);
                }
            });

            tailorsSnap.forEach(d => {
                const tailor = d.data();
                if (analytics[tailor.batchId]) {
                    analytics[tailor.batchId].tailorCosts += tailor.quantity * tailor.costPerUnit;
                }
            });

            inventorySnap.forEach(d => {
                const item = d.data();
                if (analytics[item.batchId] && item.status === 'sold') {
                    analytics[item.batchId].itemsSold++;
                    analytics[item.batchId].revenue += parseFloat(item.price || 0);
                }
            });

            const content = document.getElementById('analytics-content');
            content.innerHTML = "";
            
            Object.keys(analytics).forEach(batchId => {
                const data = analytics[batchId];
                const totalCosts = data.expenses + data.tailorCosts;
                const unitCost = data.totalShirts > 0 ? (totalCosts / data.totalShirts).toFixed(2) : 0;
                const profit = data.revenue - (totalCosts * (data.itemsSold / data.totalShirts));

                content.innerHTML += `
                    <div class="glass-card p-6 rounded-3xl shadow-lg">
                        <h4 class="text-xl font-bold mb-4">${data.name}</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Total Costs</div>
                                <div class="text-2xl font-bold text-blue-600">‚Ç¶${totalCosts.toFixed(2)}</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Unit Cost</div>
                                <div class="text-2xl font-bold text-purple-600">‚Ç¶${unitCost}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Items Sold</div>
                                <div class="text-2xl font-bold text-green-600">${data.itemsSold} / ${data.totalShirts}</div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Revenue</div>
                                <div class="text-2xl font-bold text-amber-600">‚Ç¶${data.revenue.toFixed(2)}</div>
                            </div>
                            <div class="bg-${profit >= 0 ? 'emerald' : 'rose'}-50 p-4 rounded-xl col-span-2">
                                <div class="text-xs text-slate-500 uppercase font-bold">Profit/Loss</div>
                                <div class="text-2xl font-bold text-${profit >= 0 ? 'emerald' : 'rose'}-600">‚Ç¶${profit.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        document.getElementById('download-sold-pdf').onclick = async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const batchesSnap = await getDocs(collection(db, "batches"));
            const inventorySnap = await getDocs(collection(db, "inventory"));
            
            const batchNames = {};
            batchesSnap.forEach(d => {
                batchNames[d.id] = d.data().name;
            });

            const soldItemsByBatch = {};
            inventorySnap.forEach(d => {
                const item = d.data();
                if (item.status === 'sold') {
                    const batchId = item.batchId || 'no-batch';
                    if (!soldItemsByBatch[batchId]) {
                        soldItemsByBatch[batchId] = [];
                    }
                    soldItemsByBatch[batchId].push(item);
                }
            });

            // Enhanced Header
            pdf.setFillColor(79, 70, 229);
            pdf.rect(0, 0, 210, 50, 'F');
            
            // White accent line
            pdf.setFillColor(255, 255, 255);
            pdf.rect(0, 48, 210, 2, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(36);
            pdf.setFont(undefined, 'bold');
            pdf.text("REAL STITCH", 105, 22, { align: 'center' });
            
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'normal');
            pdf.text("Sales Report - Sold Items", 105, 32, { align: 'center' });
            
            pdf.setFontSize(11);
            pdf.text(`Generated: ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`, 105, 42, { align: 'center' });

            let startY = 65;
            let totalRevenue = 0;
            let totalItemsSold = 0;

            Object.keys(soldItemsByBatch).forEach((batchId, index) => {
                const batchName = batchNames[batchId] || 'Unassigned Items';
                const items = soldItemsByBatch[batchId];
                const batchTotal = items.reduce((sum, item) => sum + parseFloat(item.price || 0), 0);
                totalRevenue += batchTotal;
                totalItemsSold += items.length;

                if (startY > 250) {
                    pdf.addPage();
                    startY = 30;
                }

                // Batch Header Card
                pdf.setDrawColor(226, 232, 240);
                pdf.setLineWidth(0.5);
                pdf.setFillColor(248, 250, 252);
                pdf.rect(14, startY - 8, 182, 15, 'FD');
                
                pdf.setTextColor(79, 70, 229);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text(`üì¶ ${batchName}`, 20, startY);
                
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(100, 116, 139);
                pdf.text(`${items.length} item${items.length !== 1 ? 's' : ''}`, 190, startY - 2, { align: 'right' });
                pdf.setTextColor(16, 185, 129);
                pdf.setFont(undefined, 'bold');
                pdf.text(`‚Ç¶${batchTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 190, startY + 5, { align: 'right' });

                startY += 12;

                const rows = items.map(item => [
                    item.name || 'N/A',
                    item.code || 'N/A',
                    `${item.sleeveType || ''} ${item.material || ''}`.trim() || 'N/A',
                    `‚Ç¶${parseFloat(item.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                ]);

                pdf.autoTable({
                    head: [['Product Name', 'Code', 'Type', 'Selling Price']],
                    body: rows,
                    startY: startY,
                    margin: { left: 14, right: 14 },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 11,
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 10,
                        textColor: [51, 65, 85],
                        cellPadding: 3
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 70, fontStyle: 'bold' },
                        1: { cellWidth: 40, halign: 'center' },
                        2: { cellWidth: 50, halign: 'center' },
                        3: { cellWidth: 32, halign: 'right', fontStyle: 'bold', textColor: [16, 185, 129] }
                    },
                    styles: {
                        lineColor: [226, 232, 240],
                        lineWidth: 0.3
                    }
                });

                startY = pdf.lastAutoTable.finalY + 20;
            });

            // Sales Summary Section
            if (startY > 240) {
                pdf.addPage();
                startY = 30;
            }

            pdf.setFillColor(16, 185, 129);
            pdf.rect(14, startY, 182, 35, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text("üí∞ SALES SUMMARY", 20, startY + 12);
            
            pdf.setDrawColor(255, 255, 255);
            pdf.setLineWidth(0.3);
            pdf.line(20, startY + 16, 190, startY + 16);
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Total Items Sold:`, 25, startY + 25);
            pdf.setFont(undefined, 'bold');
            pdf.text(`${totalItemsSold}`, 190, startY + 25, { align: 'right' });
            
            pdf.setFont(undefined, 'normal');
            pdf.text(`Total Revenue:`, 25, startY + 32);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text(`‚Ç¶${totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 190, startY + 32, { align: 'right' });

            // Footer on all pages
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                
                // Footer line
                pdf.setDrawColor(226, 232, 240);
                pdf.setLineWidth(0.5);
                pdf.line(14, 280, 196, 280);
                
                pdf.setFontSize(9);
                pdf.setTextColor(148, 163, 184);
                pdf.text(`Generated on ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} at ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`, 105, 285, { align: 'center' });
                pdf.text(`Page ${i} of ${pageCount} | Real Stitch Inventory System`, 105, 290, { align: 'center' });
            }

            pdf.save(`RealStitch_Sales_Report_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`);
        };

        // USER MANAGEMENT
        function loadUsersView() {
            onSnapshot(collection(db, "users"), (snap) => {
                const list = document.getElementById('users-list');
                list.innerHTML = "";
                
                // Show main admins
                list.innerHTML += `
                    <div class="glass-card p-6 rounded-3xl shadow-lg border-2 border-indigo-200">
                        <h4 class="font-bold text-lg mb-4 text-indigo-900">üëë Main Administrators</h4>
                        ${MAIN_ADMINS.map(email => `
                            <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-lg mb-2">
                                <div>
                                    <span class="font-semibold text-indigo-900">${email}</span>
                                    <span class="ml-3 px-2 py-1 bg-indigo-600 text-white rounded text-xs font-bold">MAIN ADMIN</span>
                                </div>
                                <span class="text-xs text-indigo-600">Permanent Access</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                snap.forEach(d => {
                    const user = d.data();
                    list.innerHTML += `
                        <div class="glass-card p-6 rounded-3xl shadow-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-semibold">${user.email}</span>
                                    <span class="ml-3 px-2 py-1 ${user.role === 'admin' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'} rounded text-xs font-bold">
                                        ${user.role === 'admin' ? 'FULL ACCESS' : 'CATALOG ONLY'}
                                    </span>
                                </div>
                                <button onclick="window.removeUser('${d.id}')" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Remove Access</button>
                            </div>
                        </div>
                    `;
                });
                
                if (snap.empty) {
                    list.innerHTML += `
                        <div class="glass-card p-12 rounded-3xl shadow-lg text-center">
                            <p class="text-slate-500">No additional users added yet.</p>
                        </div>
                    `;
                }
            });
        }

        document.getElementById('add-user-btn')?.addEventListener('click', () => {
            document.getElementById('user-modal').classList.remove('hidden');
        });

        document.getElementById('cancel-user')?.addEventListener('click', () => {
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('user-form').reset();
        });

        document.getElementById('user-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('user-email').value.toLowerCase();
            const role = document.getElementById('user-role').value;
            
            // Check if email is a main admin
            if (MAIN_ADMINS.includes(email)) {
                alert('This email is already a main administrator with permanent access.');
                return;
            }
            
            // Check if user already exists
            const existingUser = await getDocs(query(collection(db, "users"), where("email", "==", email)));
            if (!existingUser.empty) {
                alert('This user already has access to the system.');
                return;
            }
            
            await addDoc(collection(db, "users"), {
                email: email,
                role: role,
                addedBy: currentUserEmail,
                addedAt: new Date()
            });
            
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('user-form').reset();
            alert(`User ${email} has been granted ${role === 'admin' ? 'full' : 'catalog-only'} access.`);
        });

        window.removeUser = async (id) => {
            if (confirm('Are you sure you want to remove this user\'s access?')) {
                await deleteDoc(doc(db, "users", id));
                alert('User access has been removed.');
            }
        };
    </script>
</body>
</html>
