<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Stitch | Inventory</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-gradient {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
        }

        .table-row-hover:hover {
            background: rgba(241, 245, 249, 0.5);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <div id="auth-screen" class="flex flex-col items-center justify-center h-screen bg-[#0f172a] text-white">
        <div class="p-10 text-center scale-up-center">
            <img src="logo.png" alt="Real Stitch" class="w-32 h-32 mx-auto mb-6 object-contain" onerror="this.style.display='none'">
            
            <h1 class="text-6xl font-extrabold tracking-tighter mb-2 italic">REAL <span class="text-indigo-500">STITCH</span></h1>
            <p class="text-slate-400 mb-10 tracking-widest uppercase text-sm">Tailored Inventory Excellence</p>
            <button id="login-btn" class="bg-white text-slate-900 px-10 py-4 rounded-full font-bold shadow-2xl flex items-center gap-3 mx-auto hover:bg-indigo-50 transition-all">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5"> 
                Continue with Google
            </button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <nav class="sticky top-0 z-50 glass-card border-b border-slate-200 px-6 py-4 mb-8">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="RS" class="w-10 h-10 object-contain rounded-md" onerror="this.style.display='none'; document.getElementById('nav-fallback').classList.remove('hidden')">
                    
                    <div id="nav-fallback" class="hidden w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold italic text-xs">RS</div>
                    
                    <span class="text-xl font-extrabold tracking-tight">REAL STITCH</span>
                </div>
                <button id="logout-btn" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-rose-50 hover:text-rose-600 transition-colors">Logout</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 pb-20">
            <!-- QUICK TIP BANNER -->
            <div id="quick-tip" class="glass-card p-6 rounded-3xl shadow-xl mb-8 border-2 border-indigo-200">
                <div class="flex items-start gap-4">
                    <div class="bg-indigo-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl flex-shrink-0">
                        üí°
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-lg mb-2 text-indigo-900">Quick Start Guide</h4>
                        <p class="text-sm text-slate-600 mb-3">
                            <strong>Step 1:</strong> Create a batch (e.g., "Batch 003") using the <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-semibold">Batch Mgmt</span> tab ‚Üí
                            <strong>Step 2:</strong> Add items to your batch using <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-semibold">New Item</span> tab ‚Üí
                            <strong>Step 3:</strong> Track expenses and tailors for each batch ‚Üí
                            <strong>Step 4:</strong> View analytics to see your profit margins!
                        </p>
                        <div class="flex gap-2">
                            <button id="show-full-help" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-600">
                                View Full Guide
                            </button>
                            <button id="dismiss-tip" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-200">
                                Got it, dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1">
                    <div class="glass-card p-8 rounded-3xl shadow-xl sticky top-28">
                        <div class="flex gap-2 mb-6">
                            <button id="tab-batch" class="flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-indigo-500 text-white">Batch Mgmt</button>
                            <button id="tab-item" class="flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-slate-100 text-slate-600">New Item</button>
                        </div>

                        <!-- BATCH MANAGEMENT FORM -->
                        <div id="batch-form-container">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                                <span class="w-2 h-6 bg-indigo-500 rounded-full"></span> Batch Management
                            </h3>
                            <form id="batch-form" class="space-y-5">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Batch Name</label>
                                    <input type="text" id="batch-name" placeholder="e.g. Batch 003" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Total Shirts</label>
                                    <input type="number" id="batch-total" placeholder="50" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Long Sleeve</label>
                                        <input type="number" id="batch-long" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Short Sleeve</label>
                                        <input type="number" id="batch-short" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Plain</label>
                                        <input type="number" id="batch-plain" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Patterned</label>
                                        <input type="number" id="batch-patterned" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Custom Made</label>
                                    <input type="number" id="batch-custom" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                </div>
                                <button type="submit" class="w-full btn-gradient text-white p-4 rounded-2xl font-bold mt-4">Create Batch</button>
                            </form>
                        </div>

                        <!-- ITEM FORM (ORIGINAL) -->
                        <div id="item-form-container" class="hidden">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                                <span class="w-2 h-6 bg-indigo-500 rounded-full"></span> New Entry
                            </h3>
                            <form id="inventory-form" class="space-y-5">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Select Batch</label>
                                    <select id="item-batch" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                        <option value="">Select Batch</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Item Name</label>
                                    <input type="text" id="item-name" placeholder="e.g. Silk Blazer" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Serial/Code</label>
                                    <input type="text" id="item-code" placeholder="RS-001" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Sleeve Type</label>
                                        <select id="item-sleeve" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                            <option value="Long Sleeve">Long Sleeve</option>
                                            <option value="Short Sleeve">Short Sleeve</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Material</label>
                                        <select id="item-material" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                            <option value="Plain">Plain</option>
                                            <option value="Patterned">Patterned</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- NEW: Multi-Source Materials -->
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Material Sources</label>
                                        <button type="button" id="add-material-source" class="bg-indigo-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-600">+ Add Source</button>
                                    </div>
                                    <div id="material-sources-container" class="space-y-2">
                                        <input type="text" class="material-source w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" placeholder="Material Source 1">
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Custom Made?</label>
                                    <select id="item-custom" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Selling Price</label>
                                    <input type="number" id="item-price" placeholder="$" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Product Photo</label>
                                    <input type="file" id="item-image" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                </div>
                                <button type="submit" id="submit-btn" class="w-full btn-gradient text-white p-4 rounded-2xl font-bold mt-4">Save to Collection</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="flex gap-2 mb-6">
                        <button id="view-batches" class="flex-1 bg-indigo-100 text-indigo-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">View Batches</button>
                        <button id="view-expenses" class="flex-1 bg-purple-100 text-purple-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Expenses</button>
                        <button id="view-tailors" class="flex-1 bg-blue-100 text-blue-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Tailors</button>
                        <button id="view-analytics" class="flex-1 bg-amber-100 text-amber-600 px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Analytics</button>
                        <button id="view-catalog" class="flex-1 bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-all">Catalog</button>
                    </div>

                    <!-- CATALOG VIEW (ORIGINAL) -->
                    <div id="catalog-view">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Master Catalog</h3>
                                <p class="text-slate-500 text-sm">Manage your stock levels and sales.</p>
                            </div>
                            <div class="flex gap-3 items-center">
                                <div class="bg-indigo-50 px-4 py-2 rounded-xl">
                                    <label class="text-xs font-bold text-indigo-600 uppercase">Filter by Batch:</label>
                                    <select id="catalog-batch-filter" class="bg-transparent outline-none font-semibold text-sm ml-2">
                                        <option value="">All Batches</option>
                                    </select>
                                </div>
                                <button id="download-sold-pdf" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-emerald-100 transition-all flex items-center gap-2">
                                    PDF Export
                                </button>
                            </div>
                        </div>

                        <div id="catalog-by-batches"></div>
                    </div>

                    <!-- BATCHES VIEW -->
                    <div id="batches-view" class="hidden">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Production Batches</h3>
                                <p class="text-slate-500 text-sm">Track batch production and costs.</p>
                            </div>
                        </div>
                        <div id="batches-list" class="space-y-4"></div>
                    </div>

                    <!-- EXPENSES VIEW -->
                    <div id="expenses-view" class="hidden">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Batch Expenses</h3>
                                <p class="text-slate-500 text-sm">Track all production costs.</p>
                            </div>
                            <button id="add-expense-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">+ Add Expense</button>
                        </div>
                        <div id="expenses-list" class="glass-card rounded-3xl shadow-xl p-6"></div>
                    </div>

                    <!-- ADD EXPENSE MODAL -->
                    <div id="expense-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
                            <h3 class="text-2xl font-bold mb-6">Add New Expense</h3>
                            <form id="expense-form" class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Select Batch</label>
                                    <select id="expense-batch" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" required>
                                        <option value="">Choose a batch</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Category</label>
                                    <select id="expense-category" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" required>
                                        <option value="">Select category</option>
                                        <option value="Material">Material</option>
                                        <option value="Transport">Transport</option>
                                        <option value="Airtime">Airtime</option>
                                        <option value="Waybill">Waybill</option>
                                        <option value="Ironing">Ironing</option>
                                        <option value="Mending">Mending</option>
                                        <option value="Stock Keeper Fee">Stock Keeper Fee</option>
                                        <option value="Operations Specialist">Operations Specialist</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <!-- NEW: Custom Expense Name for "Other" -->
                                <div id="custom-expense-name-container" class="hidden">
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Custom Expense Name</label>
                                    <input type="text" id="custom-expense-name" placeholder="Enter expense name" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Amount ($)</label>
                                    <input type="number" id="expense-amount" step="0.01" placeholder="0.00" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="button" id="cancel-expense" class="flex-1 bg-slate-100 text-slate-600 p-3 rounded-xl font-bold">Cancel</button>
                                    <button type="submit" class="flex-1 btn-gradient text-white p-3 rounded-xl font-bold">Add Expense</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- TAILORS VIEW -->
                    <div id="tailors-view" class="hidden">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Tailor Management</h3>
                                <p class="text-slate-500 text-sm">Track tailoring assignments and payments.</p>
                            </div>
                            <button id="add-tailor-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">+ Add Task</button>
                        </div>
                        <div id="tailors-list" class="space-y-4"></div>
                    </div>

                    <!-- ADD TAILOR MODAL -->
                    <div id="tailor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <h3 class="text-2xl font-bold mb-6">Add Tailor Task</h3>
                            <form id="tailor-form" class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Select Batch</label>
                                    <select id="tailor-batch" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" required>
                                        <option value="">Choose a batch</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Tailor Name</label>
                                    <input type="text" id="tailor-name" placeholder="e.g. John Doe" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Quantity</label>
                                    <input type="number" id="tailor-quantity" placeholder="0" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Cost per Unit ($)</label>
                                    <input type="number" id="tailor-cost" step="0.01" placeholder="0.00" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Date Sent</label>
                                    <input type="date" id="tailor-sent" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Promised Date</label>
                                    <input type="date" id="tailor-promised" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none" required>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="button" id="cancel-tailor" class="flex-1 bg-slate-100 text-slate-600 p-3 rounded-xl font-bold">Cancel</button>
                                    <button type="submit" class="flex-1 btn-gradient text-white p-3 rounded-xl font-bold">Add Task</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ANALYTICS VIEW -->
                    <div id="analytics-view" class="hidden">
                        <div class="mb-6 space-y-4">
                            <div>
                                <h3 class="text-3xl font-extrabold tracking-tight">Analytics Dashboard</h3>
                                <p class="text-slate-500 text-sm">Unit costs and performance metrics.</p>
                            </div>
                            
                            <!-- NEW: P&L Report Section -->
                            <div class="glass-card p-6 rounded-3xl shadow-xl border-2 border-emerald-200">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h4 class="text-xl font-bold text-emerald-900">Monthly P&L Report</h4>
                                        <p class="text-xs text-slate-500">Automated on 1st of each month for tax reporting</p>
                                    </div>
                                    <button id="generate-pl-report" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm">Generate Report</button>
                                </div>
                                
                                <!-- Date Range Picker for Custom Reports -->
                                <div class="grid grid-cols-2 gap-4 mt-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Start Date</label>
                                        <input type="date" id="pl-start-date" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg outline-none text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">End Date</label>
                                        <input type="date" id="pl-end-date" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg outline-none text-sm">
                                    </div>
                                </div>
                                
                                <div id="pl-report-content" class="mt-4"></div>
                            </div>
                        </div>
                        
                        <div id="analytics-content" class="space-y-6"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- HELP TIPS TOOLTIP -->
        <div id="help-tooltip" class="fixed bottom-6 right-6 z-50">
            <button id="help-btn" class="bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center font-bold text-xl hover:bg-indigo-700 transition-all">
                ?
            </button>
        </div>

        <!-- HELP MODAL -->
        <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-6">
                    <h3 class="text-3xl font-bold">üìñ Quick Guide</h3>
                    <button id="close-help" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üéØ Getting Started</h4>
                        <ol class="text-sm space-y-2 list-decimal list-inside">
                            <li><strong>Create a Batch:</strong> Click "Batch Mgmt" tab ‚Üí Fill in batch details ‚Üí Click "Create Batch"</li>
                            <li><strong>Add Items:</strong> Click "New Item" tab ‚Üí Select your batch ‚Üí Add product details</li>
                            <li><strong>Track Expenses:</strong> Go to "Expenses" view ‚Üí Click "+ Add Expense" ‚Üí Select batch and enter costs</li>
                        </ol>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üíº Batch Management</h4>
                        <p class="text-sm mb-2">A batch represents a production run. For example, "Batch 003" with 50 shirts.</p>
                        <ul class="text-sm space-y-1 list-disc list-inside">
                            <li>Track how many are Long/Short sleeve</li>
                            <li>Track Plain vs Patterned materials</li>
                            <li>Mark custom-made items for premium pricing</li>
                        </ul>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üí∞ Expense Tracking</h4>
                        <p class="text-sm">Record all costs associated with each batch:</p>
                        <ul class="text-sm space-y-1 list-disc list-inside mt-2">
                            <li><strong>Material:</strong> Fabric and supplies costs</li>
                            <li><strong>Transport:</strong> Travel expenses for material sourcing</li>
                            <li><strong>Waybill:</strong> Shipping costs from Aba to Lagos</li>
                            <li><strong>Ironing/Mending:</strong> Post-production costs</li>
                            <li><strong>Other:</strong> Custom expense categories with your own names</li>
                        </ul>
                    </div>

                    <div class="bg-amber-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">‚úÇÔ∏è Tailor Management</h4>
                        <p class="text-sm mb-2">Track work assigned to different tailors:</p>
                        <ul class="text-sm space-y-1 list-disc list-inside">
                            <li>Assign specific quantities to each tailor</li>
                            <li>Set promised delivery dates</li>
                            <li>Mark when items are received</li>
                            <li>Late deliveries are automatically flagged ‚ö†Ô∏è</li>
                            <li>Toggle payment status: Pending ‚Üî Paid</li>
                        </ul>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üìä Item Status Flow</h4>
                        <p class="text-sm mb-2">Items move through three stages:</p>
                        <div class="flex items-center gap-2 text-sm mt-2">
                            <span class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded-full font-bold text-xs">AVAILABLE</span>
                            <span>‚Üí</span>
                            <span class="px-3 py-1 bg-amber-100 text-amber-600 rounded-full font-bold text-xs">DELIVERED</span>
                            <span>‚Üí</span>
                            <span class="px-3 py-1 bg-rose-100 text-rose-600 rounded-full font-bold text-xs">SOLD</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Use DELIV button when item is delivered but payment is pending</p>
                    </div>

                    <div class="bg-rose-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üìà Analytics Dashboard</h4>
                        <p class="text-sm">View real-time metrics for each batch:</p>
                        <ul class="text-sm space-y-1 list-disc list-inside mt-2">
                            <li><strong>Unit Cost:</strong> Total Costs √∑ Total Shirts</li>
                            <li><strong>Revenue:</strong> Sum of all sold items</li>
                            <li><strong>Profit/Loss:</strong> Revenue minus proportional costs</li>
                            <li><strong>Monthly P&L:</strong> Automated reports on 1st of each month for tax</li>
                            <li>Track sales progress and tailor performance</li>
                        </ul>
                    </div>

                    <div class="bg-slate-100 p-4 rounded-xl">
                        <h4 class="font-bold text-lg mb-2">üí° Pro Tips</h4>
                        <ul class="text-sm space-y-1 list-disc list-inside">
                            <li>Create batches first before adding individual items</li>
                            <li>Add all expenses as they occur for accurate unit costs</li>
                            <li>Use the Analytics view to identify profitable batches</li>
                            <li>Export sold items to PDF for record keeping</li>
                            <li>Add multiple material sources for complex items</li>
                            <li>Generate custom P&L reports for specific date ranges</li>
                        </ul>
                    </div>
                </div>

                <button id="close-help-btn" class="w-full mt-6 btn-gradient text-white p-3 rounded-xl font-bold">Got it!</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, getDocs, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDr51BYzXFgalvJAAB7qkWaOUHdYmt_btw",
            authDomain: "real-stitch.firebaseapp.com",
            projectId: "real-stitch",
            storageBucket: "real-stitch.firebasestorage.app",
            messagingSenderId: "447530536159",
            appId: "1:447530536159:web:d1502bdafcd1892ef02d6a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadTypes();
                loadInventory();
                loadBatches();
                setupTabSwitching();
                setupViewSwitching();
                setupCatalogFilter();
                setupMaterialSources();
                setupExpenseCategory();
                setupPLReport();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        function loadTypes() {
            onSnapshot(collection(db, "types"), (snap) => {
                const select = document.getElementById('item-type-select');
                if (select) {
                    select.innerHTML = '<option value="">Select</option>';
                    snap.forEach(d => {
                        select.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`;
                    });
                }
            });
        }

        // TAB SWITCHING (Batch vs Item Form)
        function setupTabSwitching() {
            const tabBatch = document.getElementById('tab-batch');
            const tabItem = document.getElementById('tab-item');
            const batchContainer = document.getElementById('batch-form-container');
            const itemContainer = document.getElementById('item-form-container');

            tabBatch.onclick = () => {
                tabBatch.classList.add('bg-indigo-500', 'text-white');
                tabBatch.classList.remove('bg-slate-100', 'text-slate-600');
                tabItem.classList.remove('bg-indigo-500', 'text-white');
                tabItem.classList.add('bg-slate-100', 'text-slate-600');
                batchContainer.classList.remove('hidden');
                itemContainer.classList.add('hidden');
            };

            tabItem.onclick = () => {
                tabItem.classList.add('bg-indigo-500', 'text-white');
                tabItem.classList.remove('bg-slate-100', 'text-slate-600');
                tabBatch.classList.remove('bg-indigo-500', 'text-white');
                tabBatch.classList.add('bg-slate-100', 'text-slate-600');
                itemContainer.classList.remove('hidden');
                batchContainer.classList.add('hidden');
            };
        }

        // NEW: Multi-Source Material Management
        function setupMaterialSources() {
            let sourceCount = 1;
            document.getElementById('add-material-source').onclick = () => {
                sourceCount++;
                const container = document.getElementById('material-sources-container');
                const newInput = document.createElement('div');
                newInput.className = 'flex gap-2';
                newInput.innerHTML = `
                    <input type="text" class="material-source flex-1 bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" placeholder="Material Source ${sourceCount}">
                    <button type="button" class="remove-source bg-rose-500 text-white px-3 rounded-lg text-xs font-bold hover:bg-rose-600">Remove</button>
                `;
                container.appendChild(newInput);
                
                newInput.querySelector('.remove-source').onclick = () => {
                    newInput.remove();
                };
            };
        }

        // NEW: Show/Hide Custom Expense Name
        function setupExpenseCategory() {
            const categorySelect = document.getElementById('expense-category');
            const customNameContainer = document.getElementById('custom-expense-name-container');
            
            categorySelect.onchange = () => {
                if (categorySelect.value === 'Other') {
                    customNameContainer.classList.remove('hidden');
                } else {
                    customNameContainer.classList.add('hidden');
                }
            };
        }

        // NEW: P&L Report Generation
        function setupPLReport() {
            // Set default dates (previous month)
            const today = new Date();
            const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            
            document.getElementById('pl-start-date').valueAsDate = firstDayLastMonth;
            document.getElementById('pl-end-date').valueAsDate = lastDayLastMonth;
            
            document.getElementById('generate-pl-report').onclick = generatePLReport;
        }

        async function generatePLReport() {
            const startDate = new Date(document.getElementById('pl-start-date').value);
            const endDate = new Date(document.getElementById('pl-end-date').value);
            endDate.setHours(23, 59, 59, 999); // Include entire end date
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const reportContent = document.getElementById('pl-report-content');
            reportContent.innerHTML = '<div class="text-center py-4">Generating report...</div>';
            
            // Get all sold items in date range
            const inventorySnap = await getDocs(collection(db, "inventory"));
            const soldItems = [];
            let totalRevenue = 0;
            
            inventorySnap.forEach(d => {
                const item = d.data();
                if (item.status === 'sold' && item.soldDate) {
                    const soldDate = item.soldDate.toDate();
                    if (soldDate >= startDate && soldDate <= endDate) {
                        soldItems.push({...item, id: d.id});
                        totalRevenue += parseFloat(item.price || 0);
                    }
                }
            });
            
            // Get all expenses
            const expensesSnap = await getDocs(collection(db, "expenses"));
            let totalExpenses = 0;
            const expensesByBatch = {};
            
            expensesSnap.forEach(d => {
                const exp = d.data();
                const amount = parseFloat(exp.amount || 0);
                totalExpenses += amount;
                if (!expensesByBatch[exp.batchId]) {
                    expensesByBatch[exp.batchId] = 0;
                }
                expensesByBatch[exp.batchId] += amount;
            });
            
            // Get tailor costs
            const tailorsSnap = await getDocs(collection(db, "tailors"));
            let totalTailorCosts = 0;
            const tailorCostsByBatch = {};
            
            tailorsSnap.forEach(d => {
                const tailor = d.data();
                const cost = tailor.quantity * tailor.costPerUnit;
                totalTailorCosts += cost;
                if (!tailorCostsByBatch[tailor.batchId]) {
                    tailorCostsByBatch[tailor.batchId] = 0;
                }
                tailorCostsByBatch[tailor.batchId] += cost;
            });
            
            // Calculate proportional costs for sold items
            const batchesSnap = await getDocs(collection(db, "batches"));
            const batches = {};
            batchesSnap.forEach(d => {
                batches[d.id] = d.data();
            });
            
            let proportionalCosts = 0;
            soldItems.forEach(item => {
                const batchId = item.batchId;
                if (batches[batchId]) {
                    const batchExpenses = (expensesByBatch[batchId] || 0) + (tailorCostsByBatch[batchId] || 0);
                    const unitCost = batchExpenses / batches[batchId].totalShirts;
                    proportionalCosts += unitCost;
                }
            });
            
            const netProfit = totalRevenue - proportionalCosts;
            
            reportContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl border-2 border-slate-200">
                    <div class="text-center mb-6">
                        <h5 class="text-lg font-bold text-slate-700">Profit & Loss Statement</h5>
                        <p class="text-xs text-slate-500">${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold">Items Sold:</span>
                            <span class="font-bold">${soldItems.length}</span>
                        </div>
                        
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold">Total Revenue:</span>
                            <span class="font-bold text-emerald-600">${totalRevenue.toFixed(2)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold">Cost of Goods Sold:</span>
                            <span class="font-bold text-rose-600">-${proportionalCosts.toFixed(2)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center bg-${netProfit >= 0 ? 'emerald' : 'rose'}-50 p-4 rounded-lg mt-4">
                            <span class="font-bold text-lg">Net ${netProfit >= 0 ? 'Profit' : 'Loss'}:</span>
                            <span class="font-bold text-2xl text-${netProfit >= 0 ? 'emerald' : 'rose'}-600">${Math.abs(netProfit).toFixed(2)}</span>
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-800"><strong>Tax Note:</strong> This report shows profit from items sold in the selected period. Consult your tax advisor for proper tax calculation.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // VIEW SWITCHING (Catalog, Batches, Expenses, Tailors, Analytics)
        function setupViewSwitching() {
            const views = {
                'view-catalog': 'catalog-view',
                'view-batches': 'batches-view',
                'view-expenses': 'expenses-view',
                'view-tailors': 'tailors-view',
                'view-analytics': 'analytics-view'
            };

            Object.keys(views).forEach(btnId => {
                document.getElementById(btnId).onclick = () => {
                    Object.values(views).forEach(v => document.getElementById(v).classList.add('hidden'));
                    document.getElementById(views[btnId]).classList.remove('hidden');
                    
                    // Update button styles
                    Object.keys(views).forEach(id => {
                        const btn = document.getElementById(id);
                        btn.classList.remove('bg-slate-800', 'text-white');
                        if (id === btnId) {
                            btn.classList.add('bg-slate-800', 'text-white');
                        }
                    });

                    // Load specific view data
                    if (btnId === 'view-batches') loadBatchesView();
                    if (btnId === 'view-expenses') loadExpensesView();
                    if (btnId === 'view-tailors') loadTailorsView();
                    if (btnId === 'view-analytics') loadAnalyticsView();
                };
            });
        }

        // BATCH FORM SUBMISSION
        document.getElementById('batch-form').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "batches"), {
                name: document.getElementById('batch-name').value,
                totalShirts: parseInt(document.getElementById('batch-total').value),
                longSleeve: parseInt(document.getElementById('batch-long').value) || 0,
                shortSleeve: parseInt(document.getElementById('batch-short').value) || 0,
                plain: parseInt(document.getElementById('batch-plain').value) || 0,
                patterned: parseInt(document.getElementById('batch-patterned').value) || 0,
                customMade: parseInt(document.getElementById('batch-custom').value) || 0,
                createdAt: new Date()
            });
            e.target.reset();
            alert('Batch created successfully!');
        };

        // LOAD BATCHES INTO DROPDOWN
        function loadBatches() {
            onSnapshot(collection(db, "batches"), (snap) => {
                const selects = ['item-batch', 'expense-batch', 'tailor-batch', 'catalog-batch-filter'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const isFilter = selectId === 'catalog-batch-filter';
                        select.innerHTML = isFilter ? '<option value="">All Batches</option>' : '<option value="">Select Batch</option>';
                        snap.forEach(d => {
                            select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
                        });
                    }
                });
            });
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        document.getElementById('inventory-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Processing...";
            btn.disabled = true;

            const file = document.getElementById('item-image').files[0];
            let imageBase64 = "";
            if (file) imageBase64 = await toBase64(file);

            // Collect all material sources
            const materialSources = Array.from(document.querySelectorAll('.material-source'))
                .map(input => input.value)
                .filter(val => val.trim() !== '');

            await addDoc(collection(db, "inventory"), {
                batchId: document.getElementById('item-batch').value,
                name: document.getElementById('item-name').value,
                code: document.getElementById('item-code').value,
                sleeveType: document.getElementById('item-sleeve').value,
                material: document.getElementById('item-material').value,
                materialSources: materialSources, // NEW: Store multiple sources
                customMade: document.getElementById('item-custom').value,
                price: document.getElementById('item-price').value,
                image: imageBase64,
                status: 'available',
                createdAt: new Date(),
                soldDate: null
            });

            btn.innerText = "Save to Collection";
            btn.disabled = false;
            e.target.reset();
            
            // Reset material sources to one input
            document.getElementById('material-sources-container').innerHTML = `
                <input type="text" class="material-source w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none text-sm" placeholder="Material Source 1">
            `;
        };

        function loadInventory() {
            const q = query(collection(db, "inventory"), orderBy("createdAt", "desc"));
            onSnapshot(q, async (inventorySnap) => {
                // Get all batches
                const batchesSnap = await getDocs(collection(db, "batches"));
                const batches = {};
                batchesSnap.forEach(d => {
                    batches[d.id] = d.data().name;
                });

                // Group inventory by batch
                const itemsByBatch = {};
                inventorySnap.forEach(d => {
                    const item = d.data();
                    const batchId = item.batchId || 'no-batch';
                    if (!itemsByBatch[batchId]) {
                        itemsByBatch[batchId] = [];
                    }
                    itemsByBatch[batchId].push({id: d.id, ...item});
                });

                // Get selected filter
                const filterValue = document.getElementById('catalog-batch-filter')?.value || '';
                
                const container = document.getElementById('catalog-by-batches');
                container.innerHTML = "";

                // Render items grouped by batch
                Object.keys(itemsByBatch).forEach(batchId => {
                    // Skip if filter is active and doesn't match
                    if (filterValue && filterValue !== batchId) return;

                    const batchName = batches[batchId] || 'Unassigned Items';
                    const items = itemsByBatch[batchId];
                    
                    container.innerHTML += `
                        <div class="mb-8">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="h-1 w-12 bg-indigo-500 rounded-full"></div>
                                <h4 class="text-2xl font-bold text-slate-800">${batchName}</h4>
                                <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">${items.length} items</span>
                            </div>
                            
                            <div class="glass-card rounded-3xl shadow-xl overflow-hidden">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-50/50 border-b border-slate-100 text-slate-400 text-[10px] font-bold uppercase tracking-widest">
                                        <tr>
                                            <th class="p-5">Visual</th>
                                            <th class="p-5">Product Details</th>
                                            <th class="p-5">Pricing</th>
                                            <th class="p-5">Status</th>
                                            <th class="p-5 text-right">Control</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${items.map(item => `
                                            <tr class="table-row-hover transition-colors">
                                                <td class="p-5">
                                                    <div class="w-16 h-16 rounded-2xl border-2 border-white shadow-sm overflow-hidden bg-slate-100">
                                                        <img src="${item.image || 'https://via.placeholder.com/64'}" class="w-full h-full object-cover">
                                                    </div>
                                                </td>
                                                <td class="p-5">
                                                    <div class="font-bold text-slate-800">${item.name}</div>
                                                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Code: ${item.code}</div>
                                                    ${item.materialSources && item.materialSources.length > 0 ? `
                                                        <div class="text-[9px] text-indigo-600 mt-1">
                                                            Sources: ${item.materialSources.join(', ')}
                                                        </div>
                                                    ` : ''}
                                                </td>
                                                <td class="p-5">
                                                    <div class="text-xs font-semibold text-slate-500">${item.sleeveType || ''} ${item.material || ''}</div>
                                                    <div class="text-indigo-600 font-bold">${item.price}</div>
                                                </td>
                                                <td class="p-5">
                                                    <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${item.status === 'sold' ? 'bg-rose-100 text-rose-600' : item.status === 'delivered' ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}">
                                                        ${item.status}
                                                    </span>
                                                </td>
                                                <td class="p-5 text-right">
                                                    <div class="flex justify-end gap-2">
                                                        <button onclick="window.setStatus('${item.id}', 'available')" class="hover:bg-emerald-50 p-2 rounded-lg transition-colors text-emerald-600 font-bold text-[10px]">AVAIL</button>
                                                        <button onclick="window.setStatus('${item.id}', 'delivered')" class="hover:bg-amber-50 p-2 rounded-lg transition-colors text-amber-600 font-bold text-[10px]">DELIV</button>
                                                        <button onclick="window.setStatus('${item.id}', 'sold')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-[10px] font-bold">SOLD</button>
                                                        <button onclick="window.delItem('${item.id}')" class="text-slate-300 hover:text-rose-500 transition-colors">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                if (container.innerHTML === "") {
                    container.innerHTML = `
                        <div class="glass-card rounded-3xl shadow-xl p-12 text-center">
                            <div class="text-6xl mb-4">üì¶</div>
                            <h3 class="text-2xl font-bold text-slate-700 mb-2">No Items Yet</h3>
                            <p class="text-slate-500">Start by creating a batch, then add items to your inventory.</p>
                        </div>
                    `;
                }
            });
        }

        // Update catalog filter when changed
        function setupCatalogFilter() {
            const filterSelect = document.getElementById('catalog-batch-filter');
            if (filterSelect) {
                filterSelect.onchange = loadInventory;
            }
        }

        window.setStatus = async (id, s) => {
            const updateData = { status: s };
            if (s === 'sold') {
                updateData.soldDate = new Date();
            }
            await updateDoc(doc(db, "inventory", id), updateData);
        };
        
        window.delItem = async (id) => { if(confirm("Permanently remove this item?")) await deleteDoc(doc(db, "inventory", id)); };

        // BATCHES VIEW
        function loadBatchesView() {
            onSnapshot(query(collection(db, "batches"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('batches-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const batch = d.data();
                    list.innerHTML += `
                        <div class="glass-card p-6 rounded-3xl shadow-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-xl font-bold">${batch.name}</h4>
                                    <p class="text-sm text-slate-500">Total: ${batch.totalShirts} shirts</p>
                                    <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                                        <div class="bg-blue-50 p-2 rounded-lg"><strong>Long:</strong> ${batch.longSleeve}</div>
                                        <div class="bg-purple-50 p-2 rounded-lg"><strong>Short:</strong> ${batch.shortSleeve}</div>
                                        <div class="bg-amber-50 p-2 rounded-lg"><strong>Plain:</strong> ${batch.plain}</div>
                                        <div class="bg-pink-50 p-2 rounded-lg"><strong>Pattern:</strong> ${batch.patterned}</div>
                                        <div class="bg-green-50 p-2 rounded-lg col-span-2"><strong>Custom:</strong> ${batch.customMade}</div>
                                    </div>
                                </div>
                                <button onclick="window.viewBatchDetails('${d.id}')" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold">Details</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.viewBatchDetails = (batchId) => {
            alert('Batch details coming soon! ID: ' + batchId);
        };

        // EXPENSES VIEW
        function loadExpensesView() {
            onSnapshot(collection(db, "expenses"), (snap) => {
                const list = document.getElementById('expenses-list');
                const expensesByBatch = {};
                
                snap.forEach(d => {
                    const exp = d.data();
                    if (!expensesByBatch[exp.batchId]) {
                        expensesByBatch[exp.batchId] = [];
                    }
                    expensesByBatch[exp.batchId].push({id: d.id, ...exp});
                });

                list.innerHTML = "";
                Object.keys(expensesByBatch).forEach(batchId => {
                    const total = expensesByBatch[batchId].reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                    list.innerHTML += `
                        <div class="mb-6">
                            <h5 class="font-bold text-lg mb-2">Batch: ${batchId}</h5>
                            <div class="space-y-2">
                                ${expensesByBatch[batchId].map(e => `
                                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg">
                                        <div>
                                            <span class="font-semibold">${e.customName || e.category}</span>
                                            <span class="text-xs text-slate-500 ml-2">${new Date(e.date?.toDate()).toLocaleDateString()}</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="font-bold text-indigo-600">${e.amount}</span>
                                            <button onclick="window.delExpense('${e.id}')" class="text-rose-500 text-xs">Delete</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-2 text-right font-bold text-lg">Total: ${total.toFixed(2)}</div>
                        </div>
                    `;
                });
            });
        }

        document.getElementById('add-expense-btn').onclick = async () => {
            document.getElementById('expense-modal').classList.remove('hidden');
        };

        document.getElementById('cancel-expense').onclick = () => {
            document.getElementById('expense-modal').classList.add('hidden');
            document.getElementById('expense-form').reset();
            document.getElementById('custom-expense-name-container').classList.add('hidden');
        };

        document.getElementById('expense-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const category = document.getElementById('expense-category').value;
            const customName = category === 'Other' ? document.getElementById('custom-expense-name').value : null;
            
            await addDoc(collection(db, "expenses"), {
                batchId: document.getElementById('expense-batch').value,
                category: category,
                customName: customName,
                amount: parseFloat(document.getElementById('expense-amount').value),
                date: new Date()
            });

            document.getElementById('expense-modal').classList.add('hidden');
            document.getElementById('expense-form').reset();
            document.getElementById('custom-expense-name-container').classList.add('hidden');
        };

        window.delExpense = async (id) => {
            if (confirm("Delete this expense?")) {
                await deleteDoc(doc(db, "expenses", id));
            }
        };

        // TAILORS VIEW
        function loadTailorsView() {
            onSnapshot(query(collection(db, "tailors"), orderBy("dateSent", "desc")), (snap) => {
                const list = document.getElementById('tailors-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const tailor = d.data();
                    const dateSent = tailor.dateSent?.toDate();
                    const promisedDate = tailor.promisedDate?.toDate();
                    const receivedDate = tailor.receivedDate?.toDate();
                    const isLate = receivedDate && promisedDate && receivedDate > promisedDate;

                    list.innerHTML += `
                        <div class="glass-card p-6 rounded-3xl shadow-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="text-lg font-bold">${tailor.tailorName}</h4>
                                    <p class="text-sm text-slate-500">Batch: ${tailor.batchId}</p>
                                    <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                                        <div><strong>Item:</strong> ${tailor.itemType}</div>
                                        <div><strong>Qty:</strong> ${tailor.quantity}</div>
                                        <div><strong>Cost/Unit:</strong> ${tailor.costPerUnit}</div>
                                        <div><strong>Total:</strong> ${(tailor.quantity * tailor.costPerUnit).toFixed(2)}</div>
                                    </div>
                                    <div class="mt-3 space-y-1 text-xs">
                                        <div><strong>Sent:</strong> ${dateSent ? dateSent.toLocaleDateString() : 'N/A'}</div>
                                        <div><strong>Promised:</strong> ${promisedDate ? promisedDate.toLocaleDateString() : 'N/A'}</div>
                                        <div class="${isLate ? 'text-rose-600 font-bold' : ''}"><strong>Received:</strong> ${receivedDate ? receivedDate.toLocaleDateString() : 'Pending'}</div>
                                        ${isLate ? '<div class="text-rose-600 font-bold">‚ö† LATE DELIVERY</div>' : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <span class="px-3 py-1 rounded-full text-[10px] font-bold ${tailor.paymentStatus === 'Paid' ? 'bg-green-100 text-green-600' : 'bg-amber-100 text-amber-600'}">
                                        ${tailor.paymentStatus}
                                    </span>
                                    <button onclick="window.updateTailorPayment('${d.id}', '${tailor.paymentStatus === 'Paid' ? 'Pending' : 'Paid'}')" class="bg-indigo-500 text-white px-3 py-1 rounded-lg text-xs">Toggle</button>
                                    <button onclick="window.markReceived('${d.id}')" class="bg-emerald-500 text-white px-3 py-1 rounded-lg text-xs">Received</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        document.getElementById('add-tailor-btn').onclick = async () => {
            document.getElementById('tailor-modal').classList.remove('hidden');
        };

        document.getElementById('cancel-tailor').onclick = () => {
            document.getElementById('tailor-modal').classList.add('hidden');
            document.getElementById('tailor-form').reset();
        };

        document.getElementById('tailor-form').onsubmit = async (e) => {
            e.preventDefault();

            await addDoc(collection(db, "tailors"), {
                batchId: document.getElementById('tailor-batch').value,
                tailorName: document.getElementById('tailor-name').value,
                itemType: '',
                quantity: parseInt(document.getElementById('tailor-quantity').value),
                costPerUnit: parseFloat(document.getElementById('tailor-cost').value),
                dateSent: new Date(document.getElementById('tailor-sent').value),
                promisedDate: new Date(document.getElementById('tailor-promised').value),
                receivedDate: null,
                paymentStatus: 'Pending'
            });

            document.getElementById('tailor-modal').classList.add('hidden');
            document.getElementById('tailor-form').reset();
        };

        window.updateTailorPayment = async (id, status) => {
            await updateDoc(doc(db, "tailors", id), { paymentStatus: status });
        };

        window.markReceived = async (id) => {
            await updateDoc(doc(db, "tailors", id), { receivedDate: new Date() });
        };

        // HELP MODAL FUNCTIONALITY
        document.getElementById('help-btn').onclick = () => {
            document.getElementById('help-modal').classList.remove('hidden');
        };

        document.getElementById('close-help').onclick = () => {
            document.getElementById('help-modal').classList.add('hidden');
        };

        document.getElementById('close-help-btn').onclick = () => {
            document.getElementById('help-modal').classList.add('hidden');
        };

        document.getElementById('show-full-help').onclick = () => {
            document.getElementById('help-modal').classList.remove('hidden');
        };

        document.getElementById('dismiss-tip').onclick = () => {
            document.getElementById('quick-tip').style.display = 'none';
        };

        // Close modals when clicking outside
        document.getElementById('expense-modal').onclick = (e) => {
            if (e.target.id === 'expense-modal') {
                document.getElementById('expense-modal').classList.add('hidden');
            }
        };

        document.getElementById('tailor-modal').onclick = (e) => {
            if (e.target.id === 'tailor-modal') {
                document.getElementById('tailor-modal').classList.add('hidden');
            }
        };

        document.getElementById('help-modal').onclick = (e) => {
            if (e.target.id === 'help-modal') {
                document.getElementById('help-modal').classList.add('hidden');
            }
        };

        // ANALYTICS VIEW
        async function loadAnalyticsView() {
            const batchesSnap = await getDocs(collection(db, "batches"));
            const expensesSnap = await getDocs(collection(db, "expenses"));
            const tailorsSnap = await getDocs(collection(db, "tailors"));
            const inventorySnap = await getDocs(collection(db, "inventory"));

            const analytics = {};
            
            batchesSnap.forEach(d => {
                const batch = d.data();
                analytics[d.id] = {
                    name: batch.name,
                    totalShirts: batch.totalShirts,
                    expenses: 0,
                    tailorCosts: 0,
                    itemsSold: 0,
                    revenue: 0
                };
            });

            expensesSnap.forEach(d => {
                const exp = d.data();
                if (analytics[exp.batchId]) {
                    analytics[exp.batchId].expenses += parseFloat(exp.amount || 0);
                }
            });

            tailorsSnap.forEach(d => {
                const tailor = d.data();
                if (analytics[tailor.batchId]) {
                    analytics[tailor.batchId].tailorCosts += tailor.quantity * tailor.costPerUnit;
                }
            });

            inventorySnap.forEach(d => {
                const item = d.data();
                if (analytics[item.batchId] && item.status === 'sold') {
                    analytics[item.batchId].itemsSold++;
                    analytics[item.batchId].revenue += parseFloat(item.price || 0);
                }
            });

            const content = document.getElementById('analytics-content');
            content.innerHTML = "";
            
            Object.keys(analytics).forEach(batchId => {
                const data = analytics[batchId];
                const totalCosts = data.expenses + data.tailorCosts;
                const unitCost = data.totalShirts > 0 ? (totalCosts / data.totalShirts).toFixed(2) : 0;
                const profit = data.revenue - (totalCosts * (data.itemsSold / data.totalShirts));

                content.innerHTML += `
                    <div class="glass-card p-6 rounded-3xl shadow-lg">
                        <h4 class="text-xl font-bold mb-4">${data.name}</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Total Costs</div>
                                <div class="text-2xl font-bold text-blue-600">${totalCosts.toFixed(2)}</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Unit Cost</div>
                                <div class="text-2xl font-bold text-purple-600">${unitCost}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Items Sold</div>
                                <div class="text-2xl font-bold text-green-600">${data.itemsSold} / ${data.totalShirts}</div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <div class="text-xs text-slate-500 uppercase font-bold">Revenue</div>
                                <div class="text-2xl font-bold text-amber-600">${data.revenue.toFixed(2)}</div>
                            </div>
                            <div class="bg-${profit >= 0 ? 'emerald' : 'rose'}-50 p-4 rounded-xl col-span-2">
                                <div class="text-xs text-slate-500 uppercase font-bold">Profit/Loss</div>
                                <div class="text-2xl font-bold text-${profit >= 0 ? 'emerald' : 'rose'}-600">${profit.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        document.getElementById('download-sold-pdf').onclick = async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Get all batches and sold items
            const batchesSnap = await getDocs(collection(db, "batches"));
            const inventorySnap = await getDocs(collection(db, "inventory"));
            
            const batchNames = {};
            batchesSnap.forEach(d => {
                batchNames[d.id] = d.data().name;
            });

            const soldItemsByBatch = {};
            inventorySnap.forEach(d => {
                const item = d.data();
                if (item.status === 'sold') {
                    const batchId = item.batchId || 'no-batch';
                    if (!soldItemsByBatch[batchId]) {
                        soldItemsByBatch[batchId] = [];
                    }
                    soldItemsByBatch[batchId].push(item);
                }
            });

            // Add logo if available (placeholder for now)
            const logoUrl = 'logo.png';
            try {
                // Try to add logo - will fail gracefully if not found
                const img = new Image();
                img.src = logoUrl;
                await new Promise((resolve) => {
                    img.onload = () => {
                        try {
                            pdf.addImage(img, 'PNG', 14, 10, 20, 20);
                        } catch(e) {
                            console.log('Logo not added');
                        }
                        resolve();
                    };
                    img.onerror = () => resolve();
                    setTimeout(resolve, 1000); // Timeout after 1 second
                });
            } catch(e) {
                console.log('Could not load logo');
            }

            // Header
            pdf.setFillColor(79, 70, 229); // Indigo color
            pdf.rect(0, 0, 210, 35, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(28);
            pdf.setFont(undefined, 'bold');
            pdf.text("REAL STITCH", 40, 20);
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text("Sales Report - Sold Items", 40, 28);
            
            // Date
            pdf.setFontSize(9);
            pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 150, 28);

            let startY = 45;
            let totalRevenue = 0;
            let totalItemsSold = 0;

            // Process each batch
            Object.keys(soldItemsByBatch).forEach((batchId, index) => {
                const batchName = batchNames[batchId] || 'Unassigned Items';
                const items = soldItemsByBatch[batchId];
                const batchTotal = items.reduce((sum, item) => sum + parseFloat(item.price || 0), 0);
                totalRevenue += batchTotal;
                totalItemsSold += items.length;

                // Check if we need a new page
                if (startY > 250) {
                    pdf.addPage();
                    startY = 20;
                }

                // Batch header
                pdf.setFillColor(241, 245, 249);
                pdf.rect(14, startY - 5, 182, 10, 'F');
                
                pdf.setTextColor(30, 41, 59);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(batchName, 16, startY);
                
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(100, 116, 139);
                pdf.text(`${items.length} items | ${batchTotal.toFixed(2)}`, 150, startY);

                startY += 10;

                // Batch items table
                const rows = items.map(item => [
                    item.name,
                    item.code,
                    `${item.sleeveType || ''} ${item.material || ''}`.trim(),
                    `${parseFloat(item.price).toFixed(2)}`
                ]);

                pdf.autoTable({
                    head: [['Product Name', 'Code', 'Type', 'Selling Price']],
                    body: rows,
                    startY: startY,
                    margin: { left: 14, right: 14 },
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 9
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: [51, 65, 85]
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 60 },
                        1: { cellWidth: 45 },
                        2: { cellWidth: 50 },
                        3: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }
                    }
                });

                startY = pdf.lastAutoTable.finalY + 15;
            });

            // Summary section
            if (startY > 240) {
                pdf.addPage();
                startY = 20;
            }

            pdf.setFillColor(79, 70, 229);
            pdf.rect(14, startY, 182, 30, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text("SALES SUMMARY", 20, startY + 10);
            
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Total Items Sold: ${totalItemsSold}`, 20, startY + 18);
            pdf.text(`Total Revenue: ${totalRevenue.toFixed(2)}`, 20, startY + 25);

            // Footer on last page
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(148, 163, 184);
                pdf.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                pdf.text('Real Stitch Inventory System', 105, 285, { align: 'center' });
            }

            pdf.save(`RealStitch_Sales_Report_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`);
        };
    </script>
</body>
</html>
